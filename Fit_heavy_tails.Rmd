# Fitting heaviy tails to modis VCF

## Setup

```{r setup, eval=T }
load(".RData")

oldcd <-getwd()

require(pander)
require(plyr)
require(dplyr)
require(ggplot2)

panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')
options("scipen"=6, "digits"=6)

#Load package
library(poweRlaw) 

#source("R/powerlaw/discpowerexp.R")
#source("R/powerlaw/discexp.R")
#source("R/powerlaw/zeta.R")

# Load functions for continuous ht distributions
#
source("R/powerlaw/powerexp.R")
source("R/powerlaw/exp.R")
source("R/powerlaw/pareto.R")

# Functions for the analysis
#
source("R/power_fun.r")

# Set global options and parameters 
#
options.glo <- vector("list", length=0)
options.glo$GOF <- 1						# Estimate godness of fit for power law 
options.glo$ploting <- 0					# Plots of cumulative distributions
options.glo$data_set_name <- ""				# image_names from wich patch sizes were calculated
options.glo$resultsDir <- ""        		# Folder with bin files  
options.glo$sample_data <- 0                # Set  >0 For testing
options.glo$original_bin_files <- ""        # Files with patch sizes for each region (bin=binary)
options.glo$xmins <- seq(1:500)				# Range of xmins (minimun patch sizes) to fit 
											#
											# Size of the maximun xmin in Km 233*233*400/(1000*1000)
options.glo$fit <- TRUE 					# Make the fits or calculate patch stats


```


# Fit heavy tailed distributions AF (Africa - new output)

```{r conheavytailfitAF, eval=F,echo=T,message=T,warning=T}


# Set folder with results for the region 
#
options.glo$resultsDir <- "Results/africa"
options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)

# The region AF must coincide with the region extracted from the filenames 
#
# options.glo$data_set_name <- options.glo$data_set_name[c(15,16)] 

fit <- region_fit_con_heavy_tail(options.glo,"AF") 

save.image()
```

# Plots fits for AF (Africa) 


```{r plotconheavytailAF, eval=F,echo=T,message=T,warning=T}

# Plots fits for AF (Africa) 
#
# The plots are saved in Results/africa folder
#
plot_size_dist_by_region("AF","Results/africa")


```

# Fit heavy tailed distributions SEAS (south asia)

```{r conheavytailfitSEAS, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 

options.glo$resultsDir <- "Results/southasia"
options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)


# The region AF must coincide with the region extracted from the filenames 
#
# options.glo$data_set_name <- options.glo$data_set_name[c(15,16)] 

fit <- region_fit_con_heavy_tail(options.glo,"SEAS") 


#  Add the fitted distribution models data to all_fit data frame 
#
all_fit <- bind_rows(all_fit,fit)

rm(fit)
save.image()



```

# Plots fits for SEAS (Africa) 
#

```{r plotconheavytailSEAS, eval=F,echo=T,message=T,warning=T}


plot_size_dist_by_region("SEAS","Results/southasia")

```


# Fit heavy tailed distributions OC (Oceania)

```{r conheavytailfitOC, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 

options.glo$resultsDir <- "Results/oceania"
options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)


# The region AF must coincide with the region extracted from the filenames 
#
# options.glo$data_set_name <- options.glo$data_set_name[c(15,16)] 

fit <- region_fit_con_heavy_tail(options.glo,"OC") 


#  Add the fitted distribution models data to all_fit data frame 
#
all_fit <- bind_rows(all_fit,fit)



# save data to disk

save.image()



```


# Plots fits for OC (Oceania) 
#

```{r plotconheavytailOC, eval=F,echo=T,message=T,warning=T}

plot_size_dist_by_region("OC","Results/oceania")

```

# Fit heavy tailed distributions SA (south america)

```{r conheavytailfitSA, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 
#
options.glo$resultsDir <- "Results/southamerica"
options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)

# The region AF must coincide with the region extracted from the filenames 
#
# options.glo$data_set_name <- options.glo$data_set_name[c(15,16)] 

fit <- region_fit_con_heavy_tail(options.glo,"SA") 

# Change to base folder  
#
setwd(oldcd)


#  Add the fitted distribution models data to all_fit data frame 
#
all_fit <- bind_rows(all_fit,fit)


save.image()

plot_size_dist_by_region("SA","Results/southamerica")


```

# North america fits

```{r conheavytailfitNA, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 
#
options.glo$resultsDir <- "Results/northamerica"
options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)

# The region AF must coincide with the region extracted from the filenames 
#
# options.glo$data_set_name <- options.glo$data_set_name[c(15,16)] 
#options(error=recover)

fit <- region_fit_con_heavy_tail(options.glo,"NA") 

# Change to base folder  
#
setwd(oldcd)


#  Add the fitted distribution models data to all_fit data frame 
#
all_fit <- bind_rows(all_fit,fit)


save.image()

plot_size_dist_by_region("NA","Results/northamerica")


```

# Fit heavy tailed distributions EUAS (Europa north asia)


```{r conheavytailfitEUAS, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 
#
options.glo$resultsDir <- "Results/eurasia"
options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)

# The region AF must coincide with the region extracted from the filenames 
#
# options.glo$data_set_name <- options.glo$data_set_name[c(15,16)] 

fit <- region_fit_con_heavy_tail(options.glo,"EUAS") 

# Change to base folder  
#
setwd(oldcd)


#  Add the fitted distribution models data to all_fit data frame 
#
all_fit <- bind_rows(all_fit,fit)

save.image()

plot_size_dist_by_region("EUAS","Results/eurasia")


```

# Fit again heavy tailed distributions EUAS 1  

```{r conheavytailfitEUAS3_SAST1, eval=F,echo=T,message=T,warning=T}


# eliminate NA_5
#
#all_fit<- filter(all_fit, grepl("NA_5",data_set_name,fixed = T))

# Delete duplicated 
#all_fit <- group_by(all_fit,region, subregion) %>% unique() %>% ungroup()


options.glo$resultsDir <- "Results/eurasia"
options.glo$xmins <- seq(1:600)				# Range of xmins (minimun patch sizes) to fit 
options.glo$sample_data <- 0                 # Set >0 For testing


all_fit <-filter(all_fit, !grepl("EUAS_3",data_set_name,fixed = T))

fit <- region_fit_con_heavy_tail(options.glo,"EUAS_3")

all_fit <- bind_rows(all_fit,fit)

setwd(oldcd)

save.image()

plot_size_dist_by_region("EUAS_3","Results/eurasia")


options.glo$resultsDir <- "Results/southamerica"

all_fit <-filter(all_fit, !grepl("SAST_1",data_set_name,fixed = T))

fit <- region_fit_con_heavy_tail(options.glo,"SAST_1")

all_fit <- bind_rows(all_fit,fit)

setwd(oldcd)

save.image()

plot_size_dist_by_region("SAST_1","Results/southamerica")



```


# Fit again heavy tailed distributions EUAS 1  with the two largest patches merged

```{r conheavytailfitEUAS1_merged, eval=T,echo=T,message=T,warning=T}




options.glo$resultsDir <- "Results/eurasia"
options.glo$xmins <- seq(1:600)				# Range of xmins (minimun patch sizes) to fit 
options.glo$sample_data <- 0                 # Set >0 For testing



fit <- merge2_region_fit_con_heavy_tail(options.glo,"EUAS_1","EUAS_1M")

all_fit <- bind_rows(all_fit,fit)

setwd(oldcd)

save.image()

plot_size_dist_by_region("EUAS_1M","Results/eurasia")

```


# Tables of parameters by region/subregion and means 

```{r poweLawRegiontables, eval=F,echo=F,message=T,warning=T}

# Build a dataframe for table output
#
nn <- c("Complete",">=Xmin")
ta <- mutate(all_fit,Data_Set=nn[match(model_set,c("Xmin=9", "Estimated Xmin"))],  xmin=round(xmin)) %>% filter(model_set=="Estimated Xmin")  # %>% filter(region %in% c('OC'))

select <- dplyr::select 

ta <- ta %>% arrange(region,subregion,model_set,year,desc(AICc_weight)) %>% 
  select(region,subregion,year,xmin,model_name,par1,par2,n,AICc_weight,GOFp) %>%  # delta_AICc,
  mutate(xmin=ifelse(lag(xmin,1) == xmin & !is.na(lag(xmin,1)), "", xmin ),
  	   year=ifelse(lag(year,1) == year & !is.na(lag(year,1)), "", year ),
#  	   Data_Set=ifelse(lag(Data_Set,1) == Data_Set & !is.na(lag(Data_Set,1)), "", Data_Set ),
  	   par1=round(par1,3),
  	   par2=round(par2,3),
  	   AICc_weight=round(AICc_weight,3)
  	   )

options("scipen"=999, "digits"=4)

write.table(pandoc.table.return(ta),file='Fitted_Patch_models.txt',quote = F,sep = "\t",row.names = F)

# pandoc.table(ta)
# 
# pandoc.table(filter(ta,region=="AF"))
# 
# pandoc.table(filter(ta,region=="EUAS"))
# 
# pandoc.table(filter(ta,region=="NA"))
# 
# pandoc.table(filter(ta,region=="OC"))
# 
# pandoc.table(filter(ta,region=="SAST"))
# 
# pandoc.table(filter(ta,region=="SAT"))
# 
# pandoc.table(filter(ta,region=="SEAS"))
# 
# Write fitted parameters and AIC comparison to ascii tab separated file
# 
ta <- all_fit  %>% filter(model_set=="Estimated Xmin") %>% arrange(region,subregion,model_set,year,desc(AICc_weight)) %>%
  	select(region,subregion,year,model_name,xmin,par1,par2,n,LL,AICc,delta_AICc,AICc_weight,GOFp) %>%
	mutate(par1=round(par1,5),
		    par2=round(par2,8),
		    xmin=round(xmin),
		    LL=round(LL,3),
		   	AICc=round(AICc,3),
		    delta_AICc=round(delta_AICc,3),
   	   		AICc_weight=round(AICc_weight,3)
  	   )


# Write table for supplementary material
#
write.table(ta,file='Fitted_Patch_models.txt',quote = F,sep = "\t",row.names = F)

write.csv(ta,file='Fitted_Patch_models.csv',row.names = F)

```

# Plot alpha and Xmin by region and subregion

```{r conheavytailplots, eval=F,echo=F,message=T,warning=T}
setwd(oldcd)

require(dplyr)
require(ggplot2)

ff <- filter(all_fit,model_name=="Power", model_set=="Estimated Xmin") %>% 
	mutate(se=(par1-1)/sqrt(n))


# Extract quantiles of alpha
#
ff$lPar1 <- sapply(ff$bPar1Quant, '[', 1)
ff$hPar1 <- sapply(ff$bPar1Quant, '[', 5)

pd <-position_dodge(.3)
g <- ggplot(ff, aes(x=year,y=par1,colour=subregion),shape=22) +  theme_bw() + geom_point(position=pd,size=1.5)+ 
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5,position=pd) + ylab(expression(alpha)) + 
	scale_colour_brewer(palette="Set1",name="Sub-region") + theme(legend.position="bottom") +  theme(axis.text.x = element_text(angle = 90, hjust = 0))


ff1<- group_by(ff,region,subregion) %>% summarise(malpha=mean(par1),mxmin=mean(xmin))

g + geom_hline(aes(yintercept=malpha,colour=subregion),ff1,linetype = 2) + facet_wrap( ~region+subregion) 

#
# I save the final figure with the fitted GLS model in next chunk 
#
# ggsave("figure/PowerExp_Xmin_year.png",width=6,height=8,units="in",dpi=600)

# The exponent of patch size distribution is tau=2.05495 at the critical point for isotropic percolation
#
# For regions with total patch area greater thant 10e7 
#
#
fff <-filter(ff,subregion==1,region!="SAT",region!="OC")
g <- ggplot(fff, aes(x=year,y=par1,colour=region),shape=21) +  theme_bw() + geom_point(position=pd,size=1.5)+ 
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5,position=pd) + ylab(expression(alpha)) +
	scale_colour_brewer(palette="Set1",name="Region") + theme(legend.position="bottom") +  theme(axis.text.x = element_text(angle = 90, hjust = 0))

ff1<- group_by(fff,region,subregion) %>% summarise(malpha=mean(par1),mxmin=mean(xmin))

g + geom_hline(aes(yintercept=malpha,colour=region),ff1,linetype = 2)
#ggsave("figure/PowerExp_gt10e7_year.png",width=6,height=6,units="in",dpi=600)

# Global mean for regions gt 10e7
#
ungroup(ff1) %>% summarise(malpha=mean(malpha),mxmin=mean(mxmin))

# malpha   mxmin
# 1.9384   445.947

# Global mean for regions less than 10e7 km
#

ff1 <-anti_join(ff,fff,by=c("region","subregion","year") )

ff1 %>% summarise(malpha=mean(par1),mxmin=mean(xmin))

#    malpha   mxmin
#    1.89634 200.471

ff %>% summarise(malpha=mean(par1),mxmin=mean(xmin))

#    malpha  mxmin
#    1.90685 261.84

# Plot of Xmin
#

# Extract quantiles of xmin
#
ff$lPar1 <- sapply(ff$bXminQuant, '[', 1)
ff$hPar1 <- sapply(ff$bXminQuant, '[', 5)

# The regions as facets 
#
g <- ggplot(ff, aes(x=year,y=xmin,colour=subregion)) +  theme_bw() + geom_point(position=pd,shape=19,size=1.5)+
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5,position=pd) +scale_colour_brewer(palette="Set1",name="Sub-region") + theme(legend.position="bottom") + theme(axis.text.x = element_text(angle = 90, hjust = 0))

ff1<- group_by(ff,region,subregion) %>% summarise(malpha=mean(par1),mxmin=mean(xmin))

g + ylab(expression(X[min])) + facet_wrap(~region,,ncol=2) + geom_hline(aes(yintercept=mxmin,colour=subregion),ff1,linetype = 2)

ggsave("figure/EstimatedXmin_year.png",width=6,height=8,units="in",dpi=600)




# Relationship between xmin & alpha 
#
g <- ggplot(ff, aes(y=par1,x=xmin,colour=subregion)) +  theme_bw() + geom_point(shape=19) + facet_wrap(~region,ncol=2)
g + xlab(expression(X[min])) + ylab(expression(alpha))  +scale_colour_brewer(palette="Set1",name="Sub-region") 
ggsave("figure/Xmin_Alpha.png",plot=g,width=6,height=8,units="in",dpi=600)


#
# Max Xmin by region
#
group_by(ff,region,subregion) %>% summarise(max_xmin=max(xmin),mean_xmin=mean(xmin))

#
# Mean alpha and Xmin by region
#
ta <-filter(all_fit,model_name=="Power",model_set=="Estimated Xmin") %>% group_by(region,subregion) %>% summarise(alpha=mean(par1),xmin=mean(xmin))

pandoc.table(ta)

#
# Proportion of Selected models 
# 

tot_fit_by_model <- all_fit %>% group_by(region,subregion,model_set,model_name) %>% mutate(tot_by_model=n()) %>% 
	filter(delta_AICc==0) %>% summarise(best_model_prop=n()/max(tot_by_model)) %>% select(model_name,best_model_prop) %>% arrange(desc(best_model_prop)) >% filter(model_set=="Estimated Xmin") 

# ggplot(tot_fit_by_model, aes(x=model_set,y=best_model_prop,fill=model_name)) + geom_bar(stat="identity", position=position_dodge()) + facet_wrap(region~subregion) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust=0),axis.title.x = element_blank()) + ylab("Best models proportion")   


#
# Plot proportion of best models by region-subregion
#
tot_fit_by_model <- tot_fit_by_model %>% ungroup %>% mutate(region = paste0(region,subregion))
ggplot(tot_fit_by_model, aes(x=region,y=best_model_prop,fill=model_name)) + geom_bar(stat="identity", position=position_dodge()) + theme_bw() + scale_colour_brewer(palette="Set1") + theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust=0),axis.title.x = element_blank()) + ylab("Best models proportion")  + scale_fill_discrete(name="Models")

ggsave("figure/ProportionSelModel.png",width=6,height=6,units="in",dpi=600)

#
# Proportion of best fit not rejected with GOF p>0.05
#
tot_fit_by_model <- all_fit %>% group_by(region,subregion,model_set,model_name) %>%	filter(model_name=="Power", model_set=="Estimated Xmin") %>% mutate(tot_power=n()) %>% filter(GOFp>0.05) %>% summarize(gof_power_model_prop=n()/max(tot_power))

pandoc.table(tot_fit_by_model)

```

# Testing differences in alpha parameter using Generalized Least Squared linear models

```{r alphaGLS, eval=F,echo=T,message=T,warning=T}

require(nlme)

ff <- filter(all_fit,model_name=="Power", model_set=="Estimated Xmin") 

#, !(region=="EUAS" & subregion==1)) # %>%mutate(se=(par1-1)/sqrt(n))


# Extract quantiles of alpha
#
ff$lPar1 <- sapply(ff$bPar1Quant, '[', 1)
ff$hPar1 <- sapply(ff$bPar1Quant, '[', 5)

ff$year <- as.numeric(ff$year)
ff$region <- paste0(ff$region,ff$subregion)  

# lm model
#
# Build weights with the bootstraped 95% intervals

ff$weight <- (ff$hPar1 - ff$lPar1)

# Not weighted lm all interactions included
am <-gls(par1 ~ region*year,data=ff)
summary(am)
re <-resid(am)
plot(am, which=1)
boxplot(re~ff$region)
boxplot(re~ff$year)

m.gls <-gls(par1 ~ region*year,data=ff,weights = varFixed(~weight))
summary(m.gls)
AIC(m.gls,am)
re <-resid(m.gls)
plot(m.gls, which=1)
boxplot(re~ff$region)
boxplot(re~ff$year)
plot(re~ff$year)
# 
ggplot(cbind(ff,re),aes(year,re)) + geom_point(shape=21) + facet_wrap(~region) + theme_bw()

acf(re)

# Add autocorrelation
#
m1.gls <-gls(par1 ~ region*year,data=ff,weights = varFixed(~weight), correlation = corAR1(form=~year| region))
anova(m1.gls,m.gls,am)

# I stay with the autocorrelation, AIC is lower, besides is not significative 

# Check interaction likelihood ration test with or without interaction

m1.gls <-gls(par1 ~ region*year,data=ff,weights = varFixed(~weight), correlation = corAR1(form=~year| region),method="ML")
anova(m1.gls,m.gls,am)
plot(m1.gls, which=1)
anova(m1.gls)
summary(m1.gls)

m0.gls <-gls(par1 ~ region+year,data=ff,weights = varFixed(~weight), correlation = corAR1(form=~year| region),method="ML")
anova(m1.gls,m0.gls)

# The final model is with interaction!
#
m1.gls <-gls(par1 ~ region*year,data=ff,weights = varFixed(~weight), correlation = corAR1(form=~year| region),method="REML")
anova(m1.gls)
summary(m1.gls)
plot(m1.gls, which=1)
pred <- predict(m1.gls)

pandoc.table(anova(m1.gls))

pandoc.table(summary(m1.gls)$tTable)

# Contrast with relevel
#
# ff$region<-as.factor(ff$region)
# ff$region <- relevel(ff$region,ref="NA1")
# m1.gls <-gls(par1 ~ region*year,data=ff,weights = varFixed(~weight), correlation = corAR1(form=~year| region),method="REML")
# anova(m1.gls)
# summary(m1.gls)$tTable
# 

# add Predictions to data frame 
#
ff <- cbind(ff,pred)

# FINAL FIGURE!!
#
pd <-position_dodge(.3)
g <- ggplot(ff, aes(x=year,y=par1,colour=subregion)) +  theme_bw() + geom_point(position=pd,size=1,shape=21)+ 
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5,position=pd) + ylab(expression(alpha)) + 
	scale_colour_brewer(palette="Set1",guide=FALSE) + theme(legend.position="bottom") +  theme(axis.text.x = element_text(angle = 90, hjust = 0))

g +  geom_line(aes(y=pred),linetype = 2)+facet_wrap( ~region)
ggsave("figure/PowerExp_Xmin_year.png",width=8,height=8,units="in",dpi=600)


# Boxplot
#
#ggplot(ff,aes(region,par1)) + geom_boxplot() + geom_jitter(width = 0.2) +  theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust=0))

# Plot of Only regions with 1e07 Km
#
ff1<-filter(ff,subregion==1,region!="SAT1",region!="OC1") 

g <- ggplot(ff1, aes(x=year,y=par1,colour=region),shape=21) +  theme_bw() + geom_point(position=pd,size=1.5)+ 
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5,position=pd) + ylab(expression(alpha)) +
	scale_colour_brewer(palette="Set1",name="Region",labels=c("AF1", "EUAS1", "NA1","SAST1","SEAS1")) + theme(legend.position="bottom") +  theme(axis.text.x = element_text(angle = 90, hjust = 0)) + scale_x_continuous(breaks=2000:2014)

g +  geom_line(aes(y=pred),linetype = 2)

ggsave("figure/PowerExp_gt10e7_year.png",width=6,height=6,units="in",dpi=600)

# 
require(multcomp)

# Add functions to use multcomp with gls
#
model.matrix.gls <- function(object, ...) {
    model.matrix(terms(object), data = getData(object), ...)
}
model.frame.gls <- function(object, ...) {
    model.frame(formula(object), data = getData(object), ...)
}
terms.gls <- function(object, ...) {
    terms(model.frame(object), ...)
}

# To aid contrast matrix specification (this are main factors)
K <- diag(length(coef(m1.gls)))[,]
rownames(K) <- names(coef(m1.gls))[]
rownames(K)[1] <-"regionAF1"

# All coefficients = 0
#
summary(glht(m1.gls, linfct = K))

# Build specific contrasts
#
contrast.matrix <- rbind("AF vs NA"=K["regionAF1",]+K["regionNA1",]*-1,
"AF vs SAST"=K["regionAF1",]+K["regionSAST1",]*-1,
"AF vs SEAS"=K["regionAF1",]+K["regionSEAS1",]*-1,
"NA vs SAST"=K["regionNA1",]+K["regionSAST1",]*-1,
"NA vs SEAS"=K["regionNA1",]+K["regionSEAS1",]*-1,
"SAST vs SEAS"=K["regionSAST1",]+K["regionSEAS1",]*-1,
"AFyear vs NAyear"=K["year",]+K["regionNA1:year",]*-1,
"AFyear vs SASTyear"=K["year",]+K["regionSAST1:year",]*-1,
"AFyear vs SEASyear"=K["year",]+K["regionSEAS1:year",]*-1,
"NAyear vs SASTyear"=K["regionNA1:year",]+K["regionSAST1:year",]*-1,
"NAyear vs SEASyear"=K["regionNA1:year",]+K["regionSEAS1:year",]*-1,
"SEASyear vs SASTyear"=K["regionSEAS1:year",]+K["regionSAST1:year",]*-1,
"AF1 NA1 SEAS1 SAST1 vs THE OTHERS"=K["regionAF1",]+K["regionNA1",]+K["regionSEAS1",]+K["regionSAST1",]+(K["regionAF2",]+ K["regionEUAS2",]+K["regionEUAS3",]+K["regionNA5",]+K["regionOC1",]+K["regionOC2",]+K["regionOC3",]+K["regionOC4",]+K["regionOC5",]+K["regionOC6",]+K["regionOC7",]+K["regionOC8",]+K["regionSAST2",]+K["regionSAT1",]+K["regionSEAS2",])*-1)

summary(glht(m1.gls, contrast.matrix))


# The global average with CI !
#
m1.gls <-gls(par1 ~ 1,data=ff,weights = varFixed(~weight), method="REML")
intervals(m1.gls)
weighted.mean(ff$par1, ff$weight)

# Bootstrapped CI for the mean
#
require(boot)

wemean <- function(dat,i) weighted.mean(dat$par1[i],dat$weight[i])
myboot <- boot(ff,wemean,R=10000)
myboot
boot.ci(myboot)

```

There is no significative differences between the 5 biggest regions AF NA SAST SEAS EUAS

# Extract max patch size and patch stats  

```{r extractPatchStats, eval=F,echo=T,message=T,warning=T}

#require(doParallel)
require(plyr)
require(dplyr)
require(ggplot2)
setwd(oldcd)ff$hPar1

options.glo$sample_data <- 0                 # Set >0 For testing
options.glo$fit <- FALSE                     # Calculate patch stats

pstat <-data.frame()


options.glo$resultsDir <- "Results/africa"
pstat <- rbind(pstat,region_fit_con_heavy_tail(options.glo,"AF") )


options.glo$resultsDir <- "Results/southasia"theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust=0)theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust=0)
pstat <- rbind(pstat,region_fit_con_heavy_tail(options.glo,"SEAS") )


options.glo$resultsDir <- "Results/oceania"
pstat <- rbind(pstat,region_fit_con_heavy_tail(options.glo,"OC") )

options.glo$resultsDir <- "Results/southamerica"
pstat <- rbind(pstat,region_fit_con_heavy_tail(options.glo,"SA") )

options.glo$resultsDir <- "Results/northamerica"
pstat <- rbind(pstat,region_fit_con_heavy_tail(options.glo,"NA") )

options.glo$resultsDir <- "Results/eurasia"
pstat <- rbind(pstat,region_fit_con_heavy_tail(options.glo,"EUAS") )

pstat <-filter(pstat,total_patch_area>100000)
#
# Max patch plot
#
g <- ggplot(pstat, aes(y=max_patch,x=year,colour=subregion)) +  theme_bw() +
	geom_point(shape=19) +  facet_wrap(~region,)
g + ylab(expression(S[max]~Km^2))  +scale_colour_brewer(palette="Set1",name="Sub-region") + scale_y_log10() + theme(axis.text.x = element_text(angle=90,hjust=0))

#ggsave("figure/max_patch_year.png",width=7,height=6,units="in",dpi=600)


save.image()



#
# Add max patch with alpha
#

ta <-filter(all_fit,model_name=="Power",model_set=="Estimated Xmin") %>% group_by(region,subregion) %>% summarise(alpha=mean(par1),xmin=mean(xmin))

ta <-inner_join(ta,group_by(pstat,region,subregion) %>% summarise(max_patch=mean(max_patch),mean_tot_area=mean(total_patch_area),prop_max_patch=max_patch/mean_tot_area))

ta
#
# Total area greater than 10.000.000
#

g <- ggplot(filter(ta,mean_tot_area>1e7), aes(y=mean_tot_area,x=alpha,colour=region)) +  theme_bw() +
	geom_point(shape=19) 
g + ylab(expression(Total~patch~area~Km^2))  +scale_colour_brewer(palette="Set1",name="Sub-region") 

#
# Total area less than 10.000.000
#

g <- ggplot(filter(ta,mean_tot_area<1e7), aes(y=mean_tot_area,x=alpha,colour=region)) +  theme_bw() +
	geom_point(shape=19) 
g + ylab(expression(Total~patch~area~Km^2))  +scale_colour_brewer(palette="Set1",name="Sub-region") 

```

# Max patch dynamics

```{r maxPatchdynamics, eval=F,echo=T,message=T,warning=T}

require(dplyr)
require(ggplot2)
require(quantreg)


#
# Calculte some deltas
# 
pstat<- group_by(pstat,region,subregion) %>%  mutate(mean_max_patch=mean(max_patch), 
											  prop_max_patch=max_patch/total_patch_area,  # Max patch proportion
											  delta_max_patch=max_patch-mean_max_patch,   # Delta max patch
											  delta_prop_max_patch=delta_max_patch/total_patch_area, # Delta max patch proportion
											  delta_year_patch=max_patch-lag(max_patch,order_by=year), 
											  delta_year_prop_patch=prop_max_patch-lag(prop_max_patch,order_by=year)
											) %>% select(-data_set_name)

#pstat$ <- mutate(pstat,delta_year_prop_patch=prop_max_patch-lag(prop_max_patch,order_by=year))

# Average RSmax 
#
ff2<- group_by(pstat,region,subregion) %>%  summarise(mmaxpatch=mean(max_patch),mtotpatch=mean(total_patch_area),mprop=mmaxpatch/mtotpatch)
pandoc.table(ff2)

#
# Max patch proportion plot greater than 1e7 Km2
#
ff1 <- filter(pstat,total_patch_area>1e7) 
pd <-position_dodge(.3)
g <- ggplot(ff1, aes(y=prop_max_patch,x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19,position=pd) 

ff2<- group_by(ff1,region) %>%  summarise(mmaxpatch=mean(max_patch),mtotpatch=mean(total_patch_area),mprop=mmaxpatch/mtotpatch)

g + ylab(expression(RS[max]))  +scale_colour_brewer(palette="Set1",name="Region",labels=c("AF1", "EUAS1", "NA1","SAST1","SEAS1")) + 
	theme(axis.text.x = element_text(angle=90,hjust=0)) + geom_hline(aes(yintercept=mprop,colour=region),ff2,linetype = 2) + scale_x_continuous(breaks=2000:2014)

ggsave("figure/max_patch_prop_year_gt1e7.png",width=6,height=6,units="in",dpi=600)

#
# Total forest patch area
#
g <- ggplot(ff1, aes(y=total_patch_area,x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19,position=pd) 
g + ylab(expression(Total~patch~area~km^2))  +scale_colour_brewer(palette="Set1",name="Region") +
	theme(axis.text.x = element_text(angle=90,hjust=0)) + geom_hline(aes(yintercept=mtotpatch,colour=region),ff2,linetype = 2) + scale_x_continuous(breaks=2000:2014)
ggsave("figure/total_patch_year_gt1e7.png",width=6,height=6,units="in",dpi=600)


#
# Max patch/total patch area plot less than 1e7 Km2
#
ff1 <- filter(pstat,total_patch_area<1e7) %>% mutate(region1=paste0(region,subregion))

g <- ggplot(ff1, aes(y=prop_max_patch,x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19,size=1) +  facet_wrap(~region1)

ff2<- group_by(ff1,region1,region) %>%  summarise(mmaxpatch=mean(max_patch),mtotpatch=mean(total_patch_area),mprop=mmaxpatch/mtotpatch)
g + ylab(expression(RS[max]))  +scale_colour_brewer(palette="Set1",name="Region",guide=F) +
	theme(axis.text.x = element_text(angle=90,hjust=0)) + geom_hline(aes(yintercept=mprop,colour=region),ff2,linetype = 2) + scale_x_continuous(breaks=seq(2000,2014,2))

ggsave("figure/max_patch_prop_year_ls1e7.png",width=8,height=8,units="in",dpi=600)


g <- ggplot(ff1, aes(y=total_patch_area,x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19) +  facet_wrap(~region1) 
g + ylab(expression(Total~patch~area~km^2))  +scale_colour_brewer(palette="Set1",name="Region",guide=F) +
	theme(axis.text.x = element_text(angle=90,hjust=0)) + geom_hline(aes(yintercept=mtotpatch,colour=region),ff2,linetype = 2) + scale_x_continuous(breaks=2000:2014)


ggsave("figure/total_patch_year_ls1e7.png",width=8,height=8,units="in",dpi=600)


#
# Fluctuations of maximun patch vs year Smax - <Smax>/TotArea
#
#
# Areas greater than 10000000 km2
#

ff1<-filter(pstat, total_patch_area>1e7) %>% ungroup() %>% mutate(region=paste0(region,subregion))

#
# Fluctuation around the mean relative to total patch area
#
g <- ggplot(ff1, aes(y=(delta_prop_max_patch),x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19) + facet_wrap(~region) #geom_smooth(method = "ml",se=F)
g + ylab(expression(Delta~RS[max]))  +scale_colour_brewer(palette="Set1",name="Region",guide=FALSE) + 
	stat_quantile(quantiles=c(.10,.50,.90),linetype=2) +
	theme(axis.text.x = element_text(angle=90,hjust=0)) #
    #geom_crossbar(aes(ymax = (delta_max_patch)/total_patch_area, ymin = 0)) 
ggsave("figure/Delta_prop_patch_year_gt1e07.png",width=7,height=5,units="in",dpi=600)



# Test if quantiles are significative
#

qu <-group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_prop_max_patch)~year,data=.,tau=c(.10)),se="boot",R=999))[2,]))) %>% mutate(tau=.10, group="Prop")

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_prop_max_patch)~year,data=.,tau=c(.50)),se="boot",R=999))[2,]))) %>% mutate(tau=.50, group="Prop"))

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_prop_max_patch)~year,data=.,tau=c(.90)),se="boot",R=999))[2,]))) %>% mutate(tau=.90, group="Prop"))


#
# Absolute Fluctuation around the mean Smax - <Smax>
#
g <- ggplot(ff1, aes(y=(delta_max_patch),x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19) + facet_wrap(~region) #geom_smooth(method = "ml",se=F)
g + ylab(expression(Delta~S[max]~~~km^2))  +scale_colour_brewer(palette="Set1",name="Region",guide=FALSE) + 
	stat_quantile(quantiles=c(.10,.50,.90),linetype=2) +
	theme(axis.text.x = element_text(angle=90,hjust=0)) #
    #geom_crossbar(aes(ymax = (delta_max_patch)/total_patch_area, ymin = 0)) 
ggsave("figure/Delta_max_patch_year_gt1e07.png",width=7,height=5,units="in",dpi=600)

# Test if quantiles are significative
#

qu <-bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_max_patch)~year,data=.,tau=c(.10)),se="boot",R=999))[2,]))) %>% mutate(tau=.10, group="Abs",Value=round(Value,0),Std..Error=round(Std..Error,0)))

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_max_patch)~year,data=.,tau=c(.50)),se="boot",R=999))[2,]))) %>% mutate(tau=.50, group="Abs",Value=round(Value,0),Std..Error=round(Std..Error,0)))

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_max_patch)~year,data=.,tau=c(.90)),se="boot",R=999))[2,]))) %>% mutate(tau=.90, group="Abs",Value=round(Value,0),Std..Error=round(Std..Error,0)))




#
# Total patch area less than 1e07
#

ff1 <- filter(pstat,total_patch_area<1e7) %>% mutate(region1=paste0(region,subregion))

#
# Fluctuations around the mean Smax - <Smax>/TotArea
#
g <- ggplot(ff1, aes(y=delta_prop_max_patch,x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19) + facet_wrap(~region1)
g + ylab(expression(Delta~RS[max])) + scale_colour_brewer(palette="Set1",name="Sub-Region",guide=F) +
	theme(axis.text.x = element_text(angle=90,hjust=0)) +
	stat_quantile(quantiles=c(.10,.50,.90),linetype=2)
	# geom_crossbar(aes(ymax = (delta_max_patch)/total_patch_area, ymin = 0)) 

ggsave("figure/Delta_prop_patch_year_ls1e07.png",width=8,height=8,units="in",dpi=600)


# Test if quantiles are significative generate table
#

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_prop_max_patch)~year,data=.,tau=c(.10)),se="boot",R=999))[2,]))) %>% mutate(tau=.10, group="Prop"))

qu <- bind_rows(qu, group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_prop_max_patch)~year,data=.,tau=c(.50)),se="boot",R=999))[2,]))) %>% mutate(tau=.50, group="Prop"))

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_prop_max_patch)~year,data=.,tau=c(.90)),se="boot",R=999))[2,]))) %>% mutate(tau=.90, group="prop"))


#
# Absolute Fluctuations around the mean Smax - <Smax>
#
g <- ggplot(ff1, aes(y=delta_max_patch,x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19) + facet_wrap(~region1)
g + ylab(expression(Delta~S[max]~~~(km^2))) + scale_colour_brewer(palette="Set1",name="Sub-Region",guide=F) +
	theme(axis.text.x = element_text(angle=90,hjust=0)) +
	stat_quantile(quantiles=c(.10,.50,.90),linetype=2)
	# geom_crossbar(aes(ymax = (delta_max_patch)/total_patch_area, ymin = 0)) 
ggsave("figure/Delta_max_patch_year_ls1e07.png",width=8,height=8,units="in",dpi=600)


# Test if quantiles are significative generate table
#

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_max_patch)~year,data=.,tau=c(.10)),se="boot",R=999))[2,]))) %>% mutate(tau=.10, group="Abs",Value=round(Value,0),Std..Error=round(Std..Error,0)))

qu <- bind_rows(qu, group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_max_patch)~year,data=.,tau=c(.50)),se="boot",R=999))[2,]))) %>% mutate(tau=.50, group="Abs",Value=round(Value,0),Std..Error=round(Std..Error,0)))

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_max_patch)~year,data=.,tau=c(.90)),se="boot",R=999))[2,]))) %>% mutate(tau=.90, group="Abs",Value=round(Value,0),Std..Error=round(Std..Error,0)))


names(qu)[4]<-"StdError"
names(qu)[5]<-"t_value"
names(qu)[6]<-"p_value"

qu <- arrange(qu,region,subregion,group,desc(tau)) %>% 
	mutate(Value=round(Value,5),StdError=round(StdError,5),t_value=round(t_value,4),p_value=round(p_value,4))

pandoc.table(qu)

rm(ff1,fff,ff2)



save.image()

```

# Fit Max patch fluctuations to heavy tail distribution

```{r fitMaxPatchDynamics, eval=F,echo=T,message=T,warning=T}

#
# Skewness 
#
ff1<-filter(pstat, total_patch_area>1e7)
ff1<-pstat
require(fitdistrplus)
ku <-do(ff1,abs_skewness=(descdist(.$delta_max_patch, discrete=FALSE, boot=500))$skewness)
ku <-inner_join(ku,do(ff1,prop_skewness=descdist(.$delta_prop_max_patch, discrete=FALSE, boot=500)$skewness))

pandoc.table(ku, round=4)

# Evaluate Gumbel or Frechet distributions???????????????

#
# Fit Absolute max patch fluctuations to power law exponential and lognormal distributions
#
ff1<-filter(pstat, total_patch_area>1e7) %>%  mutate(delta_max_patch=abs(delta_max_patch))

fit_delta<-do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,-1,T,T)) %>% arrange(AICc)
#fit_delta1<-do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,0.0001)) %>% arrange(AICc)

ff1<-filter(pstat, total_patch_area<1e7) %>% mutate(delta_max_patch=abs(delta_max_patch)) #%>% filter(!is.na(delta_year_patch))

fit_delta<-bind_rows(fit_delta, do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,-1,T,T)))

pandoc.table(group_by(fit_delta,region,subregion) %>% arrange(AICc) %>% select( region:n, AICc_weight,GOFp) %>% 
			 mutate(par1=round(par1,3),
		    par2=round(par2,3),
		    xmin=round(xmin,4),
   	   		AICc_weight=round(AICc_weight,3),
		    GOFp=round(GOFp,4))
)

#
# Fit Relative max patch fluctuations to power law exponential and lognormal distributions
#

ff1<-filter(pstat, total_patch_area>1e7) %>%  mutate(delta_max_patch=abs(delta_prop_max_patch))

fit_delta<-do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,-1,T,T)) %>% arrange(AICc)
#fit_delta1<-do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,0.0001)) %>% arrange(AICc)

ff1<-filter(pstat, total_patch_area<1e7) %>% mutate(delta_max_patch=abs(delta_prop_max_patch)) #%>% filter(!is.na(delta_year_patch))

fit_delta<-bind_rows(fit_delta, do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,-1,T,T)))
#fit_delta1<-bind_rows(fit_delta1, do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,-1)))

pandoc.table(group_by(fit_delta,region,subregion) %>% arrange(AICc) %>% dplyr::select( region:n, AICc_weight,GOFp) %>% 
			 mutate(par1=round(par1,3),
		    par2=round(par2,3),
		    xmin=round(xmin,4),
   	   		AICc_weight=round(AICc_weight,3),
		    GOFp=round(GOFp,4))
)



#
# Annual patch fluctuations and xmin
# 

ff1<-filter(pstat, total_patch_area>1e7) %>% mutate(delta_max_patch=abs(delta_max_patch)) 
ff2<-group_by(fit_delta,region,subregion) %>% select(xmin) %>% inner_join(ff1) 

g <- ggplot(ff2, aes(y=delta_max_patch,x=as.factor(year),colour=region)) +  theme_bw() +
	geom_point(shape=19) + facet_wrap(~region) #geom_smooth(method = "ml",se=F)
g + ylab("Fluctuations Max Patch") + xlab("year") +scale_colour_brewer(palette="Set1",name="Region") + 
	theme(axis.text.x = element_text(angle=90,hjust=0)) + geom_hline(aes(yintercept=xmin,colour=region),linetype = 2) 
#ggsave("figure/Annual_abs_Delta_max_patch_year_gt1e07.png",width=8,height=6,units="in",dpi=600)

g + ylab("Fluctuations Max Patch") + xlab("year") +scale_colour_brewer(palette="Set1",name="Region") + 
	theme(axis.text.x = element_text(angle=90,hjust=0)) + geom_hline(aes(yintercept=xmin,colour=region),linetype = 2) 

ff1<-filter(pstat, total_patch_area<1e7)  %>% mutate(delta_max_patch=abs(delta_max_patch)) 
ff2<-group_by(fit_delta,region,subregion) %>% select(xmin) %>% inner_join(ff1)
g <- ggplot(ff2, aes(y=abs(delta_max_patch),x=as.factor(year),colour=subregion)) +  theme_bw() +
	geom_point(shape=19) + facet_wrap(~region) #geom_smooth(method = "ml",se=F)
g + ylab("Fluctuations Max Patch") + xlab("year") +scale_colour_brewer(palette="Set1",name="Region") + 
	theme(axis.text.x = element_text(angle=90,hjust=0)) + geom_hline(aes(yintercept=xmin,colour=subregion),linetype = 2)

```


# Check for monotonic increase in variance

The fligner test and other test for monotonic trends in variances have less power than quantile regression
Fligner 23%
monotonic 51%
quantile 83%

```{r varMaxPatchDynamics, eval=F,echo=T,message=T,warning=T}
require(lawstat)
require(quantreg)



# All Regions 
#
names(pstat)
# Split in groups of 7 years
# 

ff1<-pstat %>% group_by(region,subregion) %>% mutate(period=rep(1:3,each=5,length.out=15))

#ff1<-filter(ff1, !is.na(delta_year_prop_patch))


# Variances of the two groups
#
do(ff1, data.frame(matrix(aggregate(delta_prop_max_patch~period,data=.,FUN=var)[,2],nrow = 1)))

# Check autocorrelations
#
dev.off()
do(ff1,data.frame(matrix(acf(.$delta_prop_max_patch,plot=T)$acf,nrow=1)))

# p-value is 1.96/sqrt(T-lag)= 0.565803 (lag 2)

# Fluctuations in max patch proportions
#
# Non-parametric test for an increasing trend in variances 
#
ff2 <-do(ff1, data.frame(lnested.test(.$delta_prop_max_patch,.$period,bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff2)[3] <- "Increase"
#pandoc.table(ff2[,c(1,2,4,3)])

ff3 <-do(ff1, data.frame(lnested.test(.$delta_prop_max_patch,.$period,tail="left",bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff3)[3] <- "Decrease"

pandoc.table(inner_join(ff2,ff3) %>% mutate(Increase=round(Increase,4),Decrease=round(Decrease,4)))


# Fluctuation in absolute max patch area 
#
ff2 <- do(ff1, data.frame(lnested.test(.$delta_year_patch,.$period,bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff2)[3] <- "Increase"

ff3<-do(ff1, data.frame(lnested.test(.$delta_year_patch,.$period,tail="left",bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff3)[3] <- "Decrease"

pandoc.table(inner_join(ff2,ff3) %>% mutate(Increase=round(Increase,4),Decrease=round(Decrease,4)))


# Fluctuation in absolute max patch area 
#
ff1<-pstat %>% group_by(region,subregion) %>% mutate(period=rep(1:5,each=3,length.out=15))

# Check for autocorrelations
#
do(ff1,data.frame(matrix(acf(.$delta_max_patch,plot=T)$acf,nrow=1)))

ff2 <- do(ff1, data.frame(lnested.test(.$delta_prop_max_patch,.$period,bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff2)[3] <- "Increase"

ff3<-do(ff1, data.frame(lnested.test(.$delta_year_patch,.$period,tail="left",bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff3)[3] <- "Decrease"

pandoc.table(inner_join(ff2,ff3) %>% mutate(Increase=round(Increase,4),Decrease=round(Decrease,4)))

```


