# Fitting heaviy tails to modis VCF

## Setup

```{r setup, eval=T }
load(".RData")

oldcd <-getwd()


require(pander)
require(plyr)
require(dplyr)

panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')
options("scipen"=6, "digits"=6)

#Load package
library(poweRlaw) 

#source("R/powerlaw/discpowerexp.R")
#source("R/powerlaw/discexp.R")
#source("R/powerlaw/zeta.R")

# Load functions for continuous ht distributions
#
source("R/powerlaw/powerexp.R")
source("R/powerlaw/exp.R")
source("R/powerlaw/pareto.R")

# Functions for the analysis
#
source("R/power_fun.r")

# Set global options and parameters 
#
options.glo <- vector("list", length=0)
options.glo$GOF <- 1						# Estimate godness of fit for power law 
options.glo$ploting <- 0					# Plots of cumulative distributions
options.glo$data_set_name <- ""				# image_names from wich patch sizes were calculated
options.glo$resultsDir <- ""        		# Folder with bin files  
options.glo$sample_data <- 0                # Set  >0 For testing
options.glo$original_bin_files <- ""        # Files with patch sizes for each region (bin=binary)
options.glo$xmins <- seq(1:400)				# Range of xmins (minimun patch sizes) to fit 
											#
											# Size of the maximun xmin in Km 233*233*400/(1000*1000)

```


# Fit heavy tailed distributions AF (Africa - new output)

```{r conheavytailfitAF, eval=T,echo=T,message=T,warning=T}


# Set folder with results for the region 
#
options.glo$resultsDir <- "Results/africa"
options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)

setwd(options.glo$resultsDir)

# Get files with patch sizes (*.bin) and image file names *.tif (data_set_name)
#
options.glo$original_bin_files <- list.files(pattern="*.\\.bin")
options.glo$data_set_name <- unlist(strsplit(options.glo$original_bin_files,".bin")) 

# The region AF must coincide with the region extracted from the filenames 
#
# options.glo$data_set_name <- options.glo$data_set_name[c(15,16)] 

fit <- region_fit_con_heavy_tail(options.glo,"AF") 

# Change to base folder  
#
setwd(oldcd)


# Create a data.frame to hold all the distribution models
#
all_fit <- data.frame()
all_fit <- bind_rows(all_fit,fit)



# Build a dataframe for table output
#
nn <- c("Complete",">=Xmin")
ta <- mutate(all_fit,Data_Set=nn[match(model_set,c("Xmin=9", "Estimated Xmin"))],  xmin=round(xmin))

ta <- ta %>% arrange(region,subregion,model_set,year,desc(AICc_weight)) %>% 
  select(region,subregion,year,Data_Set,xmin,model_name,par1,par2,AICc_weight,GOFp) %>% 
  mutate(xmin=ifelse(lag(xmin,1) == xmin & !is.na(lag(xmin,1)), "", xmin ),
  	   year=ifelse(lag(year,1) == year & !is.na(lag(year,1)), "", year ),
  	   Data_Set=ifelse(lag(Data_Set,1) == Data_Set & !is.na(lag(Data_Set,1)), "", Data_Set )
  	   )

options("scipen"=4, "digits"=6)

pandoc.table(ta)


save.image()

```

# Percolation indices for AF

The percolation threshold for Moore Neighborhood (z=8 3N+2N) = 0.407
Malarz, K.; S. Galam (2005). "Square-lattice site percolation at increasing ranges of neighbor bonds". Physical Review E 71 (1): 016125. 

```{r percoAnalysisAF, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 
#
options.glo$resultsDir <- "Results/africa"

set.seed(seed=0)

setwd(options.glo$resultsDir)

rnd_percolation <- read_random_percolation("AF")

region_corr <- read_region_correlation("AF")

setwd(oldcd) # oldcd is a global variable 

# The correlation exponent should be near  1.33333
#
calc_correlation_exponent(c(0.2,0.41),0.407,rnd_percolation)
#calc_correlation_exponent(c(0.1,0.41),0.407,rnd_percolation)

# Calculate the critical point!!!!1
#
ggplot(rnd_percolation,aes(p_set,correlation_length_km))+theme_bw() + geom_point(shape=1) + facet_wrap(region ~ subregion,scales="free_x")

rp <-rnd_percolation %>% filter(subregion==1) %>% mutate(p_correlation_length=correlation_length_km/max(correlation_length_km))
rp
logistic.fit = glm(p_correlation_length ~ p_set, family=binomial(logit), data = rp)
rp$fit = logistic.fit$fitted
pcrit = - logistic.fit$coefficients[1] / logistic.fit$coefficients[2]
ggplot(rp,aes(p_set,p_correlation_length))+theme_bw() + geom_point(shape=21) +
		geom_line(aes(x = p_set, y = fit), linetype = 2) +
		geom_vline(xintercept = pcrit, color = "blue") +
		annotate("text", label = sprintf("p == %.3f", pcrit), x = 0.9, y = .1, parse = TRUE) 
	
	
```

The correlation lenght have a range where is power law, if the actual correlation is less than the range the lanscape is fragmented and far from critical transition, if is greater than this range the landscape is connected.

Thus I have to find a range where the correlation lenght has a power law distribution.


# Fit heavy tailed distributions SA (south america)

```{r conheavytailfitSA, eval=F,echo=T,message=T,warning=T}
#require(doParallel)
require(plyr)
require(dplyr)


dataDir <- "Results/Southamerica"
resultsDir <- "Results/Southamerica"

##  
#  
# ~/Dropbox1T/GlobalCriticalForest/southamerica/Results

original_bin_files <- list.files(path=dataDir,pattern="*.bin")
image_names <- unlist(strsplit(original_bin_files,".bin"))


#cn <-detectCores()
#cl <- makeCluster(cn)
#registerDoParallel(cl)

set.seed(seed=0)

#all_fit<-data.frame()
#
# Add results to existing data.frame
#
fit <- data_frame()

setwd(resultsDir)
for(i_im in 1:length(image_names))
{ 
  fit <- rbind(fit,call_fit_con_heavy_tail(options.output))
}

fit$region <- "SA" # South America

all_fit <- bind_rows(all_fit,fit)

setwd(oldcd)
rm(cl,cn,fit)


# Build a dataframe for table output
#
nn <- c("Complete",">=Xmin")
#all_fit <- mutate(all_fit,model_name=nn[match(model_name,c("Power-law", "Log-normal","Exponential","Power-law w/Exp cutoff"))])
ta <- mutate(all_fit,year=substr(data_set_name,16,19),
			 Data_Set=nn[match(model_set,c("Xmin=9", "Estimated Xmin"))]) 

#ta[ta$model_set=="<Xmin",]$xmin <-ta[ta$model_set=="Estimated Xmin",]$xmin

ta <- ta %>% arrange(model_set,year,desc(AICc_weight)) %>% 
  select(year,Data_Set,xmin,model_name,par1,par2,AICc_weight,GOFp) %>% 
  mutate(xmin=ifelse(lag(xmin,1) == xmin & !is.na(lag(xmin,1)), "", xmin ),
  	   year=ifelse(lag(year,1) == year & !is.na(lag(year,1)), "", year ),
  	   Data_Set=ifelse(lag(Data_Set,1) == Data_Set & !is.na(lag(Data_Set,1)), "", Data_Set ))

options("scipen"=4, "digits"=6)

pandoc.table(ta)


save.image()

```

# Plots fits for SA

```{r conheavytailplotSA, eval=F,echo=F,message=T,warning=T}
require(dplyr)
require(ggplot2)

dataDir <- "Results/Southamerica"
resultsDir <- "Results/Southamerica"

# Read binary data
setwd(resultsDir)
set.seed(seed=0)

ccdfPlots_one_region("SA")

setwd(oldcd)

```


# Fit heavy tails for Central America CA


```{r conheavytailfitCA, eval=F,echo=T,message=T,warning=T}

dataDir <- "Results/centralamerica"
resultsDir <- "Results/centralamerica"


original_bin_files <- list.files(path=dataDir,pattern="*.bin")
image_names <- unlist(strsplit(original_bin_files,".bin"))

set.seed(seed=0)

#all_fit<-data.frame()
#
# Add results to existing data.frame
#
fit <- data_frame()
all_fit <- data_frame()

setwd(resultsDir)
for(i_im in 1:length(image_names))
{ 
  fit <- rbind(fit,call_fit_con_heavy_tail(options.output))
}


fit$region <- "CA" # Central America

all_fit <- bind_rows(all_fit,fit)

setwd(oldcd)
rm(cl,cn,fit)


# Build a dataframe for table output
#
nn <- c("Complete",">=Xmin")
ta <- mutate(all_fit,year=substr(data_set_name,16,19),
			 Data_Set=nn[match(model_set,c("Xmin=9", "Estimated Xmin"))]) 

ta <- ta %>% arrange(region,model_set,year,desc(AICc_weight)) %>% 
  select(region,year,Data_Set,xmin,model_name,par1,par2,AICc_weight,GOFp) %>% 
  mutate(xmin=ifelse(lag(xmin,1) == xmin & !is.na(lag(xmin,1)), "", xmin ),
  	   year=ifelse(lag(year,1) == year & !is.na(lag(year,1)), "", year ),
  	   Data_Set=ifelse(lag(Data_Set,1) == Data_Set & !is.na(lag(Data_Set,1)), "", Data_Set ))

options("scipen"=4, "digits"=6)

pandoc.table(ta)


save.image()


```

# Plot fits CA

```{r conheavytailplotFitCA, eval=F,echo=F,message=T,warning=T}

dataDir <- "Results/centralamerica"
resultsDir <- "Results/centralamerica"

# Read binary data
setwd(resultsDir)
set.seed(seed=0)

for( i_im in 1:length(image_names) ){
	connection_file <- file(original_bin_files[i_im], "rb")
	data_set <- readBin(connection_file, "double", n = 10^6)
	if(options.output$sample_data>0) 
		data_set<- sample(data_set,options.output$sample_data) ### TESTING
	
	nn <- strsplit(original_bin_files[i_im],".tif")[[1]][1]
	
	# Complete data set (Xmin=1)
	#
	ff <- filter(all_fit,grepl(nn,data_set_name,ignore.case = T),model_set=="Xmin=9",region=="CA")
	nn <- ff$data_set_name[1]
	na<-paste0(substr(nn,1,6),"_", substr(nn,16,19),"_",ff$model_set[1])
	cdfplot_conpl_exp(data_set,ff,na)

	# data set< Estimated Xmin (<Xmin)
	#
	ff <- filter(all_fit,grepl(nn,data_set_name,ignore.case = T),model_set=="Estimated Xmin",region=="CA")
	na<-paste0(substr(nn,1,6),"_", substr(nn,16,19),"_",ff$model_set[1])
	cdfplot_conpl_exp(data_set,ff,na)

}
setwd(oldcd)

```

# North america fits

```{r conheavytailfitNA, eval=F,echo=T,message=T,warning=T}

dataDir <- "Results/northamerica"
resultsDir <- "Results/northamerica"


original_bin_files <- list.files(path=dataDir,pattern="*.bin")
image_names <- unlist(strsplit(original_bin_files,".bin"))

set.seed(seed=0)

#all_fit<-data.frame()
#
# Add results to existing data.frame
#
fit <- data_frame()


setwd(resultsDir)
for(i_im in 1:length(image_names))
{ 
  fit <- rbind(fit,call_fit_con_heavy_tail(options.output))
}


fit$region <- "NA" # North America

all_fit <- bind_rows(all_fit,fit)

setwd(oldcd)
rm(cl,cn,fit)


# Build a dataframe for table output
#
nn <- c("Complete",">=Xmin")
ta <- mutate(all_fit,year=substr(data_set_name,16,19),
			 Data_Set=nn[match(model_set,c("Xmin=9", "Estimated Xmin"))])

ta <- ta %>% arrange(region,model_set,year,desc(AICc_weight)) %>% 
  select(region,year,Data_Set,xmin,model_name,par1,par2,AICc_weight,GOFp) %>% 
  mutate(xmin=ifelse(lag(xmin,1) == xmin & !is.na(lag(xmin,1)), "", xmin ),
  	   year=ifelse(lag(year,1) == year & !is.na(lag(year,1)), "", year ),
  	   Data_Set=ifelse(lag(Data_Set,1) == Data_Set & !is.na(lag(Data_Set,1)), "", Data_Set ))

options("scipen"=4, "digits"=6)

pandoc.table(ta)


save.image()

```



# Plot alpha and Xmin SA & CA

```{r conheavytailplotparms, eval=F,echo=F,message=T,warning=T}
setwd(oldcd)

require(dplyr)
require(ggplot2)

ff <- filter(all_fit,delta_AICc==0) %>%
	mutate(year=substr(data_set_name,16,19), se=(par1-1)/sqrt(n))

ff$lPar1 <- sapply(ff$bPar1Quant, '[', 1)
ff$hPar1 <- sapply(ff$bPar1Quant, '[', 5)

pd <-position_dodge(.1)
g <- ggplot(ff, aes(x=year,y=par1,colour=model_set,shape=model_name)) +  theme_bw() + geom_point(position=pd)+ 
	#geom_errorbar(aes(ymin=par1-se, ymax=par1+se),width=0.0,position=pd)  +
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5,position=pd) + ylab(expression(alpha))

g + scale_colour_discrete(name="Data Set",labels=c("Xmin=9","Estimated Xmin","<Xmin")) + scale_shape_discrete(name="Best Model",labels=c("Power","Power exp."))+ facet_grid(.~region) +scale_colour_brewer(palette="Set1",name="Region")
ggsave("figure/PowerExp_allXmin_year.png",plot=g,width=8,height=4,units="in",dpi=600)

ff <- filter(ff,model_set=="Estimated Xmin")
ff1<- group_by(ff,region) %>% summarise(malpha=mean(par1))
g <- ggplot(ff, aes(x=year,y=par1,colour=region)) +  theme_bw() + geom_point(position=pd)+ geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5,position=pd) + ylab(expression(alpha))
g +scale_colour_brewer(palette="Set1",name="Region") + geom_hline(aes(yintercept=malpha,colour=region),ff1)
ggsave("figure/PowerExp_Xmin_year.png",plot=g,width=6,height=4,units="in",dpi=600)



# Plot of Xmin
#

ff <- filter(all_fit,delta_AICc==0,model_set=="Estimated Xmin") %>% mutate(year=substr(data_set_name,16,19),se=(par1-1)/sqrt(n))
ff$lPar1 <- sapply(ff$bXminQuant, '[', 1)
ff$hPar1 <- sapply(ff$bXminQuant, '[', 5)

# The regions as facets 
#
g <- ggplot(ff, aes(x=year,y=xmin)) +  theme_bw() + geom_point(shape=19)+
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5)

g + ylab(expression(X[min])) + facet_grid(.~region)
#ggsave("EstimatedXmin_year.png",plot=g,width=6,height=4,units="in",dpi=600)

# The regions with different colours
#
pd <-position_dodge(.2)
g <- ggplot(ff, aes(x=year,y=xmin,colour=region)) +  theme_bw() + geom_point(shape=19,position=pd)+
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5,position=pd)

g + ylab(expression(X[min])) +scale_colour_brewer(palette="Set1",name="Region") 
ggsave("figure/EstimatedXmin_year.png",plot=g,width=6,height=4,units="in",dpi=600)

# Relationship between xmin & alpha 
#
g <- ggplot(ff, aes(x=par1,y=xmin,colour=region)) +  theme_bw() + geom_point(shape=19)
g + ylab(expression(X[min])) + xlab(expression(alpha))  +scale_colour_brewer(palette="Set1",name="Region") 
ggsave("figure/Xmin_Alpha.png",plot=g,width=6,height=4,units="in",dpi=600)

#
# Mean alpha and Xmin by region
#
filter(all_fit,model_name=="Power") %>% group_by(region,model_set) %>% summarise(alpha=mean(par1),xmin=mean(xmin))

```

# Extract max patch size 

```{r extractMaxPatchSA, eval=F,echo=T,message=T,warning=T}
#require(doParallel)
require(plyr)
require(dplyr)
require(ggplot2)

dataDir <- "Results/Southamerica"
resultsDir <- "Results/Southamerica"

options.output$region <- "SA" # For testing

original_bin_files <- list.files(path=dataDir,pattern="*.bin")
image_names <- unlist(strsplit(original_bin_files,".bin"))

setwd(resultsDir)

maxSize <-max_patch_size(image_names,options.output)

setwd(oldcd)

dataDir <- "Results/northamerica"
resultsDir <- "Results/northamerica"


original_bin_files <- list.files(path=dataDir,pattern="*.bin")
image_names <- unlist(strsplit(original_bin_files,".bin"))

setwd(resultsDir)

options.output$region <- "NA" # For testing

maxSize <-rbind(maxSize,max_patch_size(image_names,options.output))

setwd(oldcd)


dataDir <- "Results/centralamerica"
resultsDir <- "Results/centralamerica"

original_bin_files <- list.files(path=dataDir,pattern="*.bin")
image_names <- unlist(strsplit(original_bin_files,".bin"))

setwd(resultsDir)

options.output$region <- "CA" # For testing

maxSize <-rbind(maxSize,max_patch_size(image_names,options.output))

setwd(oldcd)

options("scipen"=0, "digits"=6)

maxSize <- mutate(maxSize, maxSKm2=maxS*233*233/1000000)

g <- ggplot(maxSize, aes(y=maxSKm2,x=year,colour=region)) +  theme_bw() + geom_point(shape=19)
g + ylab(expression(Biggest~forest~patch~Km^2))  +scale_colour_brewer(palette="Set1",name="Region")
ggsave("figure/Smax_year.png",plot=g,width=6,height=4,units="in",dpi=600)
# ylab(expression(S[max]))
save.image()
```
