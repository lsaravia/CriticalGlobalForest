# Fitting heaviy tails to modis VCF

## Setup

```{r setup, eval=T }
load(".RData")

oldcd <-getwd()

require(pander)
require(plyr)
require(dplyr)

panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')
options("scipen"=6, "digits"=6)

#Load package
library(poweRlaw) 

#source("R/powerlaw/discpowerexp.R")
#source("R/powerlaw/discexp.R")
#source("R/powerlaw/zeta.R")

# Load functions for continuous ht distributions
#
source("R/powerlaw/powerexp.R")
source("R/powerlaw/exp.R")
source("R/powerlaw/pareto.R")

# Functions for the analysis
#
source("R/power_fun.r")

# Set global options and parameters 
#
options.glo <- vector("list", length=0)
options.glo$GOF <- 1						# Estimate godness of fit for power law 
options.glo$ploting <- 0					# Plots of cumulative distributions
options.glo$data_set_name <- ""				# image_names from wich patch sizes were calculated
options.glo$resultsDir <- ""        		# Folder with bin files  
options.glo$sample_data <- 0                # Set  >0 For testing
options.glo$original_bin_files <- ""        # Files with patch sizes for each region (bin=binary)
options.glo$xmins <- seq(1:500)				# Range of xmins (minimun patch sizes) to fit 
											#
											# Size of the maximun xmin in Km 233*233*400/(1000*1000)

```


# Fit heavy tailed distributions AF (Africa - new output)

```{r conheavytailfitAF, eval=F,echo=T,message=T,warning=T}


# Set folder with results for the region 
#
options.glo$resultsDir <- "Results/africa"
options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)

# The region AF must coincide with the region extracted from the filenames 
#
# options.glo$data_set_name <- options.glo$data_set_name[c(15,16)] 

fit <- region_fit_con_heavy_tail(options.glo,"AF") 

# Create a data.frame to hold all the distribution models
#
all_fit <- data.frame()
all_fit <- bind_rows(all_fit,fit)

# Build a dataframe for table output
#
nn <- c("Complete",">=Xmin")
ta <- mutate(all_fit,Data_Set=nn[match(model_set,c("Xmin=9", "Estimated Xmin"))],  xmin=round(xmin))

ta <- ta %>% arrange(region,subregion,model_set,year,desc(AICc_weight)) %>% 
  select(region,subregion,year,Data_Set,xmin,model_name,par1,par2,AICc_weight,GOFp) %>%  # delta_AICc,
  mutate(xmin=ifelse(lag(xmin,1) == xmin & !is.na(lag(xmin,1)), "", xmin ),
  	   year=ifelse(lag(year,1) == year & !is.na(lag(year,1)), "", year ),
  	   Data_Set=ifelse(lag(Data_Set,1) == Data_Set & !is.na(lag(Data_Set,1)), "", Data_Set ),
  	   par1=round(par1,34),
  	   par2=round(par2,3),
  	   AICc_weight=round(AICc_weight,3)
  	   
  	   )

options("scipen"=999, "digits"=4)

pandoc.table(ta)


save.image()
```

# Plots fits for AF (Africa) 


```{r plotconheavytailAF, eval=F,echo=T,message=T,warning=T}

# Plots fits for AF (Africa) 
#
# The plots are saved in Results/africa folder
#
plot_size_dist_by_region("AF","Results/africa")


```

# Fit heavy tailed distributions SEAS (south asia)

```{r conheavytailfitSEAS, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 

options.glo$resultsDir <- "Results/southasia"
options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)


# The region AF must coincide with the region extracted from the filenames 
#
# options.glo$data_set_name <- options.glo$data_set_name[c(15,16)] 

fit <- region_fit_con_heavy_tail(options.glo,"SEAS") 


#  Add the fitted distribution models data to all_fit data frame 
#
all_fit <- bind_rows(all_fit,fit)



# Build a dataframe for table output
#
nn <- c("Complete",">=Xmin")
ta <- mutate(all_fit,Data_Set=nn[match(model_set,c("Xmin=9", "Estimated Xmin"))],  xmin=round(xmin))

ta <- ta %>% arrange(region,subregion,model_set,year,desc(AICc_weight)) %>% 
  select(region,subregion,year,Data_Set,xmin,model_name,par1,par2,AICc_weight,GOFp) %>%  # delta_AICc,
  mutate(xmin=ifelse(lag(xmin,1) == xmin & !is.na(lag(xmin,1)), "", xmin ),
  	   year=ifelse(lag(year,1) == year & !is.na(lag(year,1)), "", year ),
  	   Data_Set=ifelse(lag(Data_Set,1) == Data_Set & !is.na(lag(Data_Set,1)), "", Data_Set ),
  	   par1=round(par1,3),
  	   par2=round(par2,3),
  	   AICc_weight=round(AICc_weight,3)
  	   )

options("scipen"=999, "digits"=4)

pandoc.table(ta)

rm(fit)
save.image()



```

# Plots fits for SEAS (Africa) 
#

```{r plotconheavytailSEAS, eval=F,echo=T,message=T,warning=T}


plot_size_dist_by_region("SEAS","Results/southasia")

```


# Fit heavy tailed distributions OC (Oceania)

```{r conheavytailfitOC, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 

options.glo$resultsDir <- "Results/oceania"
options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)


# The region AF must coincide with the region extracted from the filenames 
#
# options.glo$data_set_name <- options.glo$data_set_name[c(15,16)] 

fit <- region_fit_con_heavy_tail(options.glo,"OC") 


#  Add the fitted distribution models data to all_fit data frame 
#
all_fit <- bind_rows(all_fit,fit)



# save data to disk

save.image()



```


# Plots fits for OC (Oceania) 
#

```{r plotconheavytailOC, eval=F,echo=T,message=T,warning=T}

plot_size_dist_by_region("OC","Results/oceania")

```

# Fit heavy tailed distributions SA (south america)

```{r conheavytailfitSA, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 
#
options.glo$resultsDir <- "Results/southamerica"
options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)

# The region AF must coincide with the region extracted from the filenames 
#
# options.glo$data_set_name <- options.glo$data_set_name[c(15,16)] 

fit <- region_fit_con_heavy_tail(options.glo,"SA") 

# Change to base folder  
#
setwd(oldcd)


#  Add the fitted distribution models data to all_fit data frame 
#
all_fit <- bind_rows(all_fit,fit)



# Build a dataframe for table output
#
nn <- c("Complete",">=Xmin")
ta <- mutate(all_fit,Data_Set=nn[match(model_set,c("Xmin=9", "Estimated Xmin"))],  xmin=round(xmin)) %>% filter(region %in% c('OC'))


ta <- ta %>% arrange(region,subregion,model_set,year,desc(AICc_weight)) %>% 
  select(region,subregion,year,xmin,model_name,par1,par2,AICc_weight,GOFp) %>%  # delta_AICc,
  mutate(xmin=ifelse(lag(xmin,1) == xmin & !is.na(lag(xmin,1)), "", xmin ),
  	   year=ifelse(lag(year,1) == year & !is.na(lag(year,1)), "", year ),
#  	   Data_Set=ifelse(lag(Data_Set,1) == Data_Set & !is.na(lag(Data_Set,1)), "", Data_Set ),
  	   par1=round(par1,3),
  	   par2=round(par2,3),
  	   AICc_weight=round(AICc_weight,3)
  	   )

options("scipen"=999, "digits"=4)

write(pandoc.table.return(ta),file='fitted.txt')

save.image()

plot_size_dist_by_region("SA","Results/southamerica")


```

# North america fits

```{r conheavytailfitNA, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 
#
options.glo$resultsDir <- "Results/northamerica"
options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)

# The region AF must coincide with the region extracted from the filenames 
#
# options.glo$data_set_name <- options.glo$data_set_name[c(15,16)] 
#options(error=recover)

fit <- region_fit_con_heavy_tail(options.glo,"NA") 

# Change to base folder  
#
setwd(oldcd)


#  Add the fitted distribution models data to all_fit data frame 
#
all_fit <- bind_rows(all_fit,fit)



# Build a dataframe for table output
#
nn <- c("Complete",">=Xmin")
ta <- mutate(all_fit,Data_Set=nn[match(model_set,c("Xmin=9", "Estimated Xmin"))],  xmin=round(xmin))

ta <- ta %>% arrange(region,subregion,model_set,year,desc(AICc_weight)) %>% 
  select(region,subregion,year,Data_Set,xmin,model_name,par1,par2,AICc_weight,GOFp) %>% 
  mutate(xmin=ifelse(lag(xmin,1) == xmin & !is.na(lag(xmin,1)), "", xmin ),
       year=ifelse(lag(year,1) == year & !is.na(lag(year,1)), "", year ),
       Data_Set=ifelse(lag(Data_Set,1) == Data_Set & !is.na(lag(Data_Set,1)), "", Data_Set )
       )

options("scipen"=4, "digits"=6)

pandoc.table(ta)


save.image()

plot_size_dist_by_region("NA","Results/northamerica")


```

# Fit heavy tailed distributions EUAS (Europa north asia)


```{r conheavytailfitEUAS, eval=T,echo=T,message=T,warning=T}

# Set folder with results for the region 
#
options.glo$resultsDir <- "Results/eurasia"
options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)

# The region AF must coincide with the region extracted from the filenames 
#
# options.glo$data_set_name <- options.glo$data_set_name[c(15,16)] 

fit <- region_fit_con_heavy_tail(options.glo,"EUAS") 

# Change to base folder  
#
setwd(oldcd)


#  Add the fitted distribution models data to all_fit data frame 
#
all_fit <- bind_rows(all_fit,fit)

save.image()


# Build a dataframe for table output
#
nn <- c("Complete",">=Xmin")
ta <- mutate(all_fit,Data_Set=nn[match(model_set,c("Xmin=9", "Estimated Xmin"))],  xmin=round(xmin))

ta <- ta %>% arrange(region,subregion,model_set,year,desc(AICc_weight)) %>% 
  select(region,subregion,year,Data_Set,xmin,model_name,par1,par2,AICc_weight,GOFp) %>% 
  mutate(xmin=ifelse(lag(xmin,1) == xmin & !is.na(lag(xmin,1)), "", xmin ),
       year=ifelse(lag(year,1) == year & !is.na(lag(year,1)), "", year ),
       Data_Set=ifelse(lag(Data_Set,1) == Data_Set & !is.na(lag(Data_Set,1)), "", Data_Set )
       )

options("scipen"=4, "digits"=6)

pandoc.table(ta)



plot_size_dist_by_region("EUAS","Results/eurasia")


```


# Plot alpha and Xmin by region and subregion

```{r conheavytailplotparms, eval=F,echo=F,message=T,warning=T}
setwd(oldcd)

require(dplyr)
require(ggplot2)

ff <- filter(all_fit,model_name=="Power", model_set=="Estimated Xmin") %>% 
	mutate(se=(par1-1)/sqrt(n))


# Extract quantiles of alpha
#
ff$lPar1 <- sapply(ff$bPar1Quant, '[', 1)
ff$hPar1 <- sapply(ff$bPar1Quant, '[', 5)

pd <-position_dodge(.3)
g <- ggplot(ff, aes(x=year,y=par1,colour=subregion),shape=21) +  theme_bw() + geom_point(position=pd)+ 
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5,position=pd) + ylab(expression(alpha)) + facet_wrap(~region) +
	scale_colour_brewer(palette="Set1",name="Sub-region") + theme(legend.position="bottom")

ff1<- group_by(ff,region,subregion) %>% summarise(malpha=mean(par1),mxmin=mean(xmin))

g + geom_hline(aes(yintercept=malpha,colour=subregion),ff1,linetype = 2)

#ggsave("figure/PowerExp_Xmin_year.png",plot=g,width=6,height=4,units="in",dpi=600)

# The exponent of patch size distribution is tau=2.05495 at the critical point for isotropic percolation
# The values observed for Africa are much lower. 


# Plot of Xmin
#

# Extract quantiles of xmin
#
ff$lPar1 <- sapply(ff$bXminQuant, '[', 1)
ff$hPar1 <- sapply(ff$bXminQuant, '[', 5)

# The regions as facets 
#
g <- ggplot(ff, aes(x=year,y=xmin,colour=subregion)) +  theme_bw() + geom_point(position=pd,shape=19)+
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5,position=pd) +scale_colour_brewer(palette="Set1",name="Sub-region") + theme(legend.position="bottom") 

g + ylab(expression(X[min])) + facet_wrap(~region) + geom_hline(aes(yintercept=mxmin,colour=subregion),ff1,linetype = 2)

ggsave("figure/EstimatedXmin_year.png",plot=g,width=6,height=4,units="in",dpi=600)

# Relationship between xmin & alpha 
#
g <- ggplot(ff, aes(x=par1,y=xmin,colour=subregion)) +  theme_bw() + geom_point(shape=19) + facet_wrap(~region)
g + ylab(expression(X[min])) + xlab(expression(alpha))  +scale_colour_brewer(palette="Set1",name="Sub-region") 
ggsave("figure/Xmin_Alpha.png",plot=g,width=6,height=4,units="in",dpi=600)

#
# Mean alpha and Xmin by region
#
filter(all_fit,model_name=="Power") %>% group_by(region,subregion,model_set) %>% summarise(alpha=mean(par1),xmin=mean(xmin))


#
# Proportion of best fit models
# 

tot_fit_by_model <- all_fit %>% group_by(region,subregion,model_set,model_name) %>% mutate(tot_by_model=n()) %>% 
	filter(delta_AICc==0) %>% summarise(best_model_prop=n()/max(tot_by_model)) %>% select(model_name,best_model_prop)

ggplot(tot_fit_by_model, aes(x=model_set,y=best_model_prop,fill=model_name)) + geom_bar(stat="identity", position=position_dodge()) + facet_grid(subregion~region) + theme_bw() + scale_colour_brewer(palette="Set1")

```

# Extract max patch size 

```{r extractMaxPatchSA, eval=F,echo=T,message=T,warning=T}
#require(doParallel)
require(plyr)
require(dplyr)
require(ggplot2)

dataDir <- "Results/southamerica"
resultsDir <- "Results/southamerica"

options.output$region <- "SA" # For testing

original_bin_files <- list.files(path=dataDir,pattern="*.bin")
image_names <- unlist(strsplit(original_bin_files,".bin"))

setwd(resultsDir)

maxSize <-max_patch_size(image_names,options.output)

setwd(oldcd)

dataDir <- "Results/northamerica"
resultsDir <- "Results/northamerica"


original_bin_files <- list.files(path=dataDir,pattern="*.bin")
image_names <- unlist(strsplit(original_bin_files,".bin"))

setwd(resultsDir)

options.output$region <- "NA" # For testing

maxSize <-rbind(maxSize,max_patch_size(image_names,options.output))

setwd(oldcd)


dataDir <- "Results/centralamerica"
resultsDir <- "Results/centralamerica"

original_bin_files <- list.files(path=dataDir,pattern="*.bin")
image_names <- unlist(strsplit(original_bin_files,".bin"))

setwd(resultsDir)

options.output$region <- "CA" # For testing

maxSize <-rbind(maxSize,max_patch_size(image_names,options.output))

setwd(oldcd)

options("scipen"=0, "digits"=6)

maxSize <- mutate(maxSize, maxSKm2=maxS*233*233/1000000)

g <- ggplot(maxSize, aes(y=maxSKm2,x=year,colour=region)) +  theme_bw() + geom_point(shape=19)
g + ylab(expression(Biggest~forest~patch~Km^2))  +scale_colour_brewer(palette="Set1",name="Region")
ggsave("figure/Smax_year.png",plot=g,width=6,height=4,units="in",dpi=600)
# ylab(expression(S[max]))

save.image()



```
