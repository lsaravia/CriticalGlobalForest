# Fitting heaviy tails to modis VCF

## Setup

```{r setup, eval=T }
load(".RData")
#simul  <- F # variable to perform or not the simulations

oldcd <-getwd()


require(pander)
require(plyr)

panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')
options("scipen"=6, "digits"=6)

#Load package
library(poweRlaw) 

#source("R/powerlaw/discpowerexp.R")
#source("R/powerlaw/discexp.R")
#source("R/powerlaw/zeta.R")

# Load functions for continuous ht distributions
#
source("R/powerlaw/powerexp.R")
source("R/powerlaw/exp.R")
source("R/powerlaw/pareto.R")

# Functions for the analysis
#
source("R/power_fun.r")

dataDir <- "Results/Southamerica"
codeDir <- "R"
resultsDir <- "Results/Southamerica"

##  
#  
# ~/Dropbox1T/GlobalCriticalForest/southamerica/Results


original_bin_files <- list.files(path=dataDir,pattern="*.bin")
# Delete already processed files
#
#original_bin_files <-original_bin_files[-c(1,11)]
image_names <- unlist(strsplit(original_bin_files,".bin"))

options.output <- vector("list", length=0)
options.output$GOF <- 1
options.output$ploting <- 0
options.output$data_set_name <- image_names
options.output$resultsDir <- resultsDir 
options.output$sample_data <- 0 # For testing
```

# Fit heavy tailed distributions

```{r conheavytailfit, eval=T,echo=T,message=T,warning=T}
require(doParallel)
require(plyr)
require(dplyr)


#cn <-detectCores()
#cl <- makeCluster(cn)
#registerDoParallel(cl)

set.seed(seed=0)

#all_fit<-data.frame()
#
# Add results to existing data.frame
#
fit <- data_frame()
all_fit <- data_frame()

setwd(resultsDir)
for(i_im in 1:length(image_names))
{ 
  fit <- rbind(fit,call_fit_con_heavy_tail(options.output))
}
all_fit <- bind_rows(all_fit,fit)

setwd(oldcd)
rm(cl,cn,fit)


# Build a dataframe for table output
#
nn <- c("Complete",">=Xmin")
#all_fit <- mutate(all_fit,model_name=nn[match(model_name,c("Power-law", "Log-normal","Exponential","Power-law w/Exp cutoff"))])
ta <- mutate(all_fit,year=substr(data_set_name,16,19),
			 Data_Set=nn[match(model_set,c("Xmin=9", "Estimated Xmin"))]) 

#ta[ta$model_set=="<Xmin",]$xmin <-ta[ta$model_set=="Estimated Xmin",]$xmin

ta <- ta %>% arrange(model_set,year,desc(AICc_weight)) %>% 
  select(year,Data_Set,xmin,model_name,par1,par2,AICc_weight,GOFp) %>% 
  mutate(xmin=ifelse(lag(xmin,1) == xmin & !is.na(lag(xmin,1)), "", xmin ),
  	   year=ifelse(lag(year,1) == year & !is.na(lag(year,1)), "", year ),
  	   Data_Set=ifelse(lag(Data_Set,1) == Data_Set & !is.na(lag(Data_Set,1)), "", Data_Set ))

options("scipen"=4, "digits"=6)

pandoc.table(ta)

save.image()

```

# Plots of fits, and exponents with SE

```{r conheavytailplotfreq, eval=F,echo=F,message=T,warning=T}
require(dplyr)

# Change model name
#nn <- c("Power","LogNorm","Exp","PowerExp")
#all_fit <- mutate(all_fit,model_name=nn[match(model_name,c("Power-law", "Log-normal","Exponential","Power-law w/Exp cutoff"))])
#all_fit <- mutate(all_fit,data_set_name=unlist(data_set_name))

# Read binary data
setwd(resultsDir)
set.seed(seed=0)

for( i_im in 1:length(image_names) ){
	connection_file <- file(original_bin_files[i_im], "rb")
	data_set <- readBin(connection_file, "double", n = 10^6)
	if(options.output$sample_data>0) 
		data_set<- sample(data_set,options.output$sample_data) ### TESTING
	
	nn <- strsplit(original_bin_files[i_im],".tif")[[1]][1]
	
	# Complete data set (Xmin=1)
	#
	ff <- filter(all_fit,data_set_name==nn,model_set=="Xmin=9")
	na<-paste0(substr(nn,1,6),"_", substr(nn,16,19),"_",ff$model_set[1])
	cdfplot_conpl_exp(data_set,ff,na)
	#
	#na<-paste0(substr(nn,1,6),"_", substr(nn,16,19),"_Freq_",ff$model_set[1])
	#freq_plot_con_ht(data_set,ff,na)
	#cdfplot_con_ht(data_set,ff,paste0(na,"B"))

	# data set< Estimated Xmin (<Xmin)
	#
	ff <- filter(all_fit,data_set_name==nn,model_set=="Estimated Xmin")
	na<-paste0(substr(nn,1,6),"_", substr(nn,16,19),"_",ff$model_set[1])
	cdfplot_conpl_exp(data_set,ff,na)

	#na<-paste0(substr(nn,1,6),"_", substr(nn,16,19),"_Freq_",ff$model_set[1])
	#freq_plot_con_ht(data_set,ff,na)

	# data set>=Estimated Xmin (Estimated Xmin)
	#	
# 	xmax <- ff$xmin[1]
# 	ff <- filter(all_fit,data_set_name==nn,model_set=="<Xmin")
# 	na<-paste0(substr(nn,1,6),"_", substr(nn,16,19),"_",ff$model_set[1])
# 	cdfplot_conpl_exp(data_set,ff,na,xmax)

	#na<-paste0(substr(nn,1,6),"_", substr(nn,16,19),"_Freq_",ff1$model_set[1])
	#freq_plot_con_ht(data_set,ff1,na)
}

require(ggplot2)
require(dplyr)
#ff <- bind_rows(ff,	filter(all_fit,model_set=="<Xmin",model_name=="Power"))
ff <- filter(all_fit,delta_AICc==0) %>%
	mutate(year=substr(data_set_name,16,19), se=(par1-1)/sqrt(n))

ff$lPar1 <- sapply(ff$bPar1Quant, '[', 1)
ff$hPar1 <- sapply(ff$bPar1Quant, '[', 5)

pd <-position_dodge(.1)
g <- ggplot(ff, aes(x=year,y=par1,colour=model_set,shape=model_name)) +  theme_bw() + geom_point(position=pd)+ 
	#geom_errorbar(aes(ymin=par1-se, ymax=par1+se),width=0.0,position=pd)  +
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5,position=pd) + ylab(expression(alpha))

g + scale_colour_discrete(name="Data Set",labels=c("Xmin=9","Estimated Xmin","<Xmin")) +
	scale_shape_discrete(name="Best Model",labels=c("Power","Power exp."))
ggsave("PowerExp_xmin_year.png",plot=g,width=6,height=4,units="in",dpi=600)

# Plot of Xmin
# 
ff <- filter(all_fit,delta_AICc==0,model_set=="Estimated Xmin") %>% mutate(year=substr(data_set_name,16,19),se=(par1-1)/sqrt(n))
ff$lPar1 <- sapply(ff$bXminQuant, '[', 1)
ff$hPar1 <- sapply(ff$bXminQuant, '[', 5)

g <- ggplot(ff, aes(x=year,y=xmin)) +  theme_bw() + geom_point(shape=19,colour="red")+
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5)

g + ylab(expression(X[min]))
ggsave("EstimatedXmin_year.png",plot=g,width=6,height=4,units="in",dpi=600)


# Relationship between xmin & alpha 
#
g <- ggplot(ff, aes(x=par1,y=xmin)) +  theme_bw() + geom_point(shape=19,colour="red")
g + ylab(expression(X[min])) + xlab(expression(alpha))

# There is no trend

setwd(oldcd)
rm(data_set,ff,ff1,nn,na)

```


