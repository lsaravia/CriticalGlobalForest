# Sensitivity of the Power laws and max patch metrics to the threshold value to detect forest

## Setup

```{r setup, eval=T }
load(".RData")

oldcd <-getwd()

require(pander)
require(plyr)
require(dplyr)
require(ggplot2)
require(tictoc)

panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')
options("scipen"=6, "digits"=6)

#Load package
library(poweRlaw) 

#source("R/powerlaw/discpowerexp.R")
#source("R/powerlaw/discexp.R")
#source("R/powerlaw/zeta.R")

# Load functions for continuous ht distributions
#
source("R/powerlaw/powerexp.R")
source("R/powerlaw/exp.R")
source("R/powerlaw/pareto.R")

# Functions for the analysis
#
source("R/power_fun.r")

# Set global options and parameters 
#
options.glo <- vector("list", length=0)
options.glo$GOF <- 0						# Estimate godness of fit for power law 
options.glo$ploting <- 0					# Plots of cumulative distributions
options.glo$data_set_name <- ""				# image_names from wich patch sizes were calculated
options.glo$resultsDir <- ""        		# Folder with bin files  
options.glo$sample_data <- 0                # Set  >0 For testing
options.glo$original_bin_files <- ""        # Files with patch sizes for each region (bin=binary)
options.glo$xmins <- seq(1:500)				# Range of xmins (minimun patch sizes) to fit 
											#
											# Size of the maximun xmin in Km 233*233*400/(1000*1000)
options.glo$fit <- TRUE 					# Make the fits or calculate patch stats

# UPDATE -> I deleted the estimation for fixed Xmin, only Estimated Xmin 
#



```
## Dataframes 

* all_fit: has all the fits of distributions with threshold=30, including GOF and bootstap confidence intervals of power laws

* all_fit_threshold: has all the fits with differnt thresholds  no GOF no bootstrap estimation 
# Fit heavy tailed distributions AF (Africa - new output)

```{r conheavytailfitAF, eval=F,echo=T,message=T,warning=T}


# Set folder with results for the region 
#
# The original analysis
#
# options.glo$resultsDir <- "Results/africa"

# Folder with new data sets with different thresholds
#
options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/africa"
options.glo$sample_data <- 0                 # Set >0 For testing


# Set random seed for reproducibility 
#
set.seed(seed=0)

# Fit the heavy tailed distributions for all binary files in the folder
#
tic("Fitting heavy tailed")
fit <- region_fit_con_heavy_tail(options.glo,"AF") 
toc()

# add to a new global data_frame
#
all_fit_threshold <- data_frame()
all_fit_threshold <- bind_rows(all_fit_threshold,fit)

rm(fit)
save.image()

# Fitting heavy tailed: 7481.035 sec elapsed, NO paralell code and no GOF

# Plots fits for AF (Africa) 
#
# The plots are saved in Results/africa folder
#
#
#plot_size_dist_by_region("AF","Results/africa",30)


```

# Fit heavy tailed distributions SEAS (south asia)

```{r conheavytailfitSEAS, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 

# options.glo$resultsDir <- "Results/southasia"
options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/southasia"

options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)


tic("Fitting heavy tailed SEAS")

fit <- region_fit_con_heavy_tail(options.glo,"SEAS") 

toc()

# Fitting heavy tailed SEAS: 5125.844 sec elapsed

# Add the fitted distribution models data to all_fit data frame 
#
# add to a new global data_frame
#
all_fit_threshold <- bind_rows(all_fit_threshold,fit)

rm(fit)
save.image()

# Plots fits
#
# plot_size_dist_by_region("SEAS","Results/southasia")

```


# Fit heavy tailed distributions OC (Oceania)

```{r conheavytailfitOC, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 

#options.glo$resultsDir <- "Results/oceania"
options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/oceania"

options.glo$sample_data <- 0                 # Set >0 For testing

set.seed(seed=0)

tic("Fitting heavy tailed OC")
fit <- region_fit_con_heavy_tail(options.glo,"OC") 
toc()
# Fitting heavy tailed OC: 3233.113 sec elapsed

#  Add the fitted distribution models data to all_fit data frame 
#
all_fit_threshold <- bind_rows(all_fit_threshold,fit)

rm(fit)
save.image()

# plot_size_dist_by_region("OC","Results/oceania")

```



# Fit heavy tailed distributions SA (south america)

```{r conheavytailfitSA, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 
#
# options.glo$resultsDir <- "Results/southamerica"

# Sensititivity analisis and new 2015 
#
options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/southamerica"

options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)

tic("Fitting heavy tailed SA")

fit <- region_fit_con_heavy_tail(options.glo,"SA") 

toc()
# Fitting heavy tailed SA: 9271.123 sec elapsed

#  Add the fitted distribution models data to all_fit data frame 
#
all_fit_threshold <- bind_rows(all_fit_threshold,fit)

rm(fit)

save.image()

# Plots HAVE TO FILTER BY THRESHOLD VALUE!!!!
#
#plot_size_dist_by_region("SA","Results/southamerica")


```

# North america fits

```{r conheavytailfitNA, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 
#
#options.glo$resultsDir <- "Results/northamerica"
#
options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/northamerica"

options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)


tic("Fitting heavy tailed NA")

fit <- region_fit_con_heavy_tail(options.glo,"NA") 

toc()
# Fitting heavy tailed NA: 7948.865 sec elapsed

#  Add the fitted distribution models data to all_fit data frame 
#
all_fit_threshold <- bind_rows(all_fit_threshold,fit)

rm(fit)

save.image()

#
#plot_size_dist_by_region("NA","Results/northamerica")
#

```

# Fit heavy tailed distributions EUAS (Europa north asia)



```{r conheavytailfitEUAS, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 
#
# options.glo$resultsDir <- "Results/eurasia"
options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/eurasia"

options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)

tic("Fitting heavy tailed EUAS")

fit <- region_fit_con_heavy_tail(options.glo,"EUAS") 

toc()



#  Add the fitted distribution models data to all_fit data frame 
#
all_fit_threshold <- bind_rows(all_fit_threshold,fit)

rm(fit)

save.image()

# plot_size_dist_by_region("EUAS","Results/eurasia")


```

# Plot alpha and Xmin by region and subregion

```{r conheavytailplots, eval=F,echo=F,message=T,warning=T}
setwd(oldcd)

require(dplyr)
require(ggplot2)

ff <- filter(all_fit_threshold,model_name=="Power", model_set=="Estimated Xmin") %>% 
	mutate(se=(par1-1)/sqrt(n),lPar1=par1-2*se,hPar1=par1+2*se)

pd <-position_dodge(.3)
g <- ggplot(ff, aes(x=year,y=par1,colour=threshold),shape=22) +  theme_bw() + geom_point(position=pd,size=1.5)+ 
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5,position=pd) + ylab(expression(alpha)) + 
	scale_colour_brewer(palette="Set1",guide=F) + theme(legend.position="bottom") +  theme(axis.text.x = element_text(angle = 90, hjust = 0))


ff1<- group_by(ff,region,subregion) %>% summarise(malpha=mean(par1),mxmin=mean(xmin))

g + geom_hline(aes(yintercept=malpha,colour=subregion),ff1,linetype = 2) + facet_wrap( ~region+subregion) 

fff <-filter(ff,subregion==1,region!="SAT",region!="OC")
g <- ggplot(fff, aes(x=year,y=par1,colour=threshold),shape=21) +  theme_bw() + geom_point(position=pd,size=1.5)+ 
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5,position=pd) + ylab(expression(alpha)) +
	scale_colour_brewer(palette="Set1",name="Region") + theme(legend.position="bottom") +  theme(axis.text.x = element_text(angle = 90, hjust = 0))

ff1<- group_by(fff,region,subregion) %>% summarise(malpha=mean(par1),mxmin=mean(xmin))

g + geom_hline(aes(yintercept=malpha),ff1,linetype = 2) + facet_wrap( ~region)
#ggsave("figure/PowerExp_gt10e7_year.png",width=6,height=6,units="in",dpi=600)


#
# Mean alpha and Xmin by region
#
ta <-filter(all_fit_threshold,model_name=="Power",model_set=="Estimated Xmin") %>% group_by(region,subregion,threshold) %>% summarise(alpha=mean(par1),xmin=mean(xmin))

pandoc.table(ta)

#
# Proportion of Selected models 
# 
names(all_fit_treshold)
tot_fit_by_model <- all_fit_threshold %>% group_by(region,subregion,threshold,model_name) %>% mutate(tot_by_model=n()) %>% 
	filter(delta_AICc==0) %>% summarise(best_model_prop=n()/max(tot_by_model)) %>% select(model_name,best_model_prop)  

#
# Plot proportion of best models by region-subregion
#
unique(tot_fit_by_model$threshold)
tot_fit_by_model1 <- tot_fit_by_model %>% ungroup %>% mutate(region = paste0(region,subregion)) %>% filter(threshold %in% c(25,27.5,30,32.5,35))
ggplot(tot_fit_by_model1, aes(x=region,y=best_model_prop,fill=model_name)) + geom_bar(stat="identity") + theme_bw() + scale_colour_brewer(palette="Set1") + theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust=0),axis.title.x = element_blank()) + ylab("Best models proportion")  + scale_fill_discrete(name="Models") + facet_wrap( ~threshold )

ggsave("figure/BestModelByThreshold.png",width=8,height=6,units="in",dpi=600)



```

# Testing differences in alpha parameter using Generalized Least Squared linear models

```{r alphaGLS, eval=F,echo=T,message=T,warning=T}

ff <- filter(all_fit_threshold,model_name=="Power", model_set=="Estimated Xmin", threshold %in% c(25,27.5,30,32.5,35)) %>% 
	mutate(se=(par1-1)/sqrt(n),weight=se,year=as.numeric(year),region=paste0(region,subregion)  )



require(boot)
mymean <- function(dat,i) mean(dat[i])

threshold_ci <- group_by(ff,region,threshold) %>% do( {
				myboot <- boot(.$par1,mymean,R=10000)
				myci <- boot.ci(myboot)
				data_frame(malpha=myboot$t0,low=myci$bca[4],high=myci$bca[5])
				})
threshold_ci1 <- filter(threshold_ci,threshold %in% c(25,27.5,30,32.5,35))
require(viridis)
ggplot(threshold_ci1, aes(threshold,malpha,colour=region)) + geom_point(shape=22) + geom_linerange(aes(ymin = low, ymax = high)) +theme_bw()+ ylab(expression(paste("Average ",alpha)))+ coord_flip() + scale_colour_viridis(discrete = T,guide=FALSE) + facet_wrap(~region)

ggsave("figure/AverageAlphaByRegionThreshold.png",width=8,height=6,units="in",dpi=600)



```

# Extract max patch size and patch stats  

```{r extractPatchStats, eval=F,echo=T,message=T,warning=T}

#require(doParallel)
require(plyr)
require(dplyr)
require(ggplot2)
setwd(oldcd)

options.glo$sample_data <- 0                 # Set >0 For testing
options.glo$fit <- FALSE                     # Calculate patch stats

pstat_threshold <-data.frame()


options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/africa"

pstat_threshold <- rbind(pstat_threshold,region_fit_con_heavy_tail(options.glo,"AF") )


options.glo$resultsDir <- "Results/southasia"

pstat <- rbind(pstat,region_fit_con_heavy_tail(options.glo,"SEAS") )


options.glo$resultsDir <- "Results/oceania"
pstat <- rbind(pstat,region_fit_con_heavy_tail(options.glo,"OC") )

options.glo$resultsDir <- "Results/southamerica"
pstat <- rbind(pstat,region_fit_con_heavy_tail(options.glo,"SA") )

options.glo$resultsDir <- "Results/northamerica"
pstat <- rbind(pstat,region_fit_con_heavy_tail(options.glo,"NA") )

options.glo$resultsDir <- "Results/eurasia"
pstat <- rbind(pstat,region_fit_con_heavy_tail(options.glo,"EUAS") )

pstat <-filter(pstat,total_patch_area>100000)
#
# Max patch plot
#
g <- ggplot(pstat, aes(y=max_patch,x=year,colour=subregion)) +  theme_bw() +
	geom_point(shape=19) +  facet_wrap(~region,)
g + ylab(expression(S[max]~Km^2))  +scale_colour_brewer(palette="Set1",name="Sub-region") + scale_y_log10() + theme(axis.text.x = element_text(angle=90,hjust=0))

#ggsave("figure/max_patch_year.png",width=7,height=6,units="in",dpi=600)


save.image()



#
# Add max patch with alpha
#

ta <-filter(all_fit,model_name=="Power",model_set=="Estimated Xmin") %>% group_by(region,subregion) %>% summarise(alpha=mean(par1),xmin=mean(xmin))

ta <-inner_join(ta,group_by(pstat,region,subregion) %>% summarise(max_patch=mean(max_patch),mean_tot_area=mean(total_patch_area),prop_max_patch=max_patch/mean_tot_area))

ta
#
# Total area greater than 10.000.000
#

g <- ggplot(filter(ta,mean_tot_area>1e7), aes(y=mean_tot_area,x=alpha,colour=region)) +  theme_bw() +
	geom_point(shape=19) 
g + ylab(expression(Total~patch~area~Km^2))  +scale_colour_brewer(palette="Set1",name="Sub-region") 

#
# Total area less than 10.000.000
#

g <- ggplot(filter(ta,mean_tot_area<1e7), aes(y=mean_tot_area,x=alpha,colour=region)) +  theme_bw() +
	geom_point(shape=19) 
g + ylab(expression(Total~patch~area~Km^2))  +scale_colour_brewer(palette="Set1",name="Sub-region") 

```

# Max patch dynamics

```{r maxPatchdynamics, eval=F,echo=T,message=T,warning=T}

require(dplyr)
require(ggplot2)
require(quantreg)


#
# Calculte some deltas
# 
pstat<- group_by(pstat,region,subregion) %>%  mutate(mean_max_patch=mean(max_patch), 
											  prop_max_patch=max_patch/total_patch_area,  # Max patch proportion
											  delta_max_patch=max_patch-mean_max_patch,   # Delta max patch
											  delta_prop_max_patch=delta_max_patch/total_patch_area, # Delta max patch proportion
											  delta_year_patch=max_patch-lag(max_patch,order_by=year), 
											  delta_year_prop_patch=prop_max_patch-lag(prop_max_patch,order_by=year)
											) %>% select(-data_set_name)

#pstat$ <- mutate(pstat,delta_year_prop_patch=prop_max_patch-lag(prop_max_patch,order_by=year))

# Average RSmax 
#
ff2<- group_by(pstat,region,subregion) %>%  summarise(mmaxpatch=mean(max_patch),mtotpatch=mean(total_patch_area),mprop=round(mmaxpatch/mtotpatch,2))
pandoc.table(ff2,round=2)

#
# Max patch proportion plot greater than 1e7 Km2
#
ff1 <- filter(pstat,total_patch_area>1e7) 
pd <-position_dodge(.3)
g <- ggplot(ff1, aes(y=prop_max_patch,x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19,position=pd) 

ff2<- group_by(ff1,region) %>%  summarise(mmaxpatch=mean(max_patch),mtotpatch=mean(total_patch_area),mprop=mmaxpatch/mtotpatch)

g + ylab(expression(RS[max]))  +scale_colour_brewer(palette="Set1",name="Region",labels=c("AF1", "EUAS1", "NA1","SAST1","SEAS1")) + 
	theme(axis.text.x = element_text(angle=90,hjust=0)) + geom_hline(aes(yintercept=mprop,colour=region),ff2,linetype = 2) + scale_x_continuous(breaks=2000:2014)

ggsave("figure/max_patch_prop_year_gt1e7.png",width=6,height=6,units="in",dpi=600)

#
# Total forest patch area
#
g <- ggplot(ff1, aes(y=total_patch_area,x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19,position=pd) 
g + ylab(expression(Total~patch~area~km^2))  +scale_colour_brewer(palette="Set1",name="Region") +
	theme(axis.text.x = element_text(angle=90,hjust=0)) + geom_hline(aes(yintercept=mtotpatch,colour=region),ff2,linetype = 2) + scale_x_continuous(breaks=2000:2014)
ggsave("figure/total_patch_year_gt1e7.png",width=6,height=6,units="in",dpi=600)


#
# Max patch/total patch area plot less than 1e7 Km2
#
ff1 <- filter(pstat,total_patch_area<1e7) %>% mutate(region1=paste0(region,subregion))

g <- ggplot(ff1, aes(y=prop_max_patch,x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19,size=1) +  facet_wrap(~region1)

ff2<- group_by(ff1,region1,region) %>%  summarise(mmaxpatch=mean(max_patch),mtotpatch=mean(total_patch_area),mprop=mmaxpatch/mtotpatch)
g + ylab(expression(RS[max]))  +scale_colour_brewer(palette="Set1",name="Region",guide=F) +
	theme(axis.text.x = element_text(angle=90,hjust=0)) + geom_hline(aes(yintercept=mprop,colour=region),ff2,linetype = 2) + scale_x_continuous(breaks=seq(2000,2014,2))

ggsave("figure/max_patch_prop_year_ls1e7.png",width=8,height=8,units="in",dpi=600)


g <- ggplot(ff1, aes(y=total_patch_area,x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19) +  facet_wrap(~region1) 
g + ylab(expression(Total~patch~area~km^2))  +scale_colour_brewer(palette="Set1",name="Region",guide=F) +
	theme(axis.text.x = element_text(angle=90,hjust=0)) + geom_hline(aes(yintercept=mtotpatch,colour=region),ff2,linetype = 2) + scale_x_continuous(breaks=2000:2014)


ggsave("figure/total_patch_year_ls1e7.png",width=8,height=8,units="in",dpi=600)


#
# Fluctuations of maximun patch vs year Smax - <Smax>/TotArea
#
#
# Areas greater than 10000000 km2
#

ff1<-filter(pstat, total_patch_area>1e7) %>% ungroup() %>% mutate(region=paste0(region,subregion))

#
# Fluctuation around the mean relative to total patch area
#
g <- ggplot(ff1, aes(y=(delta_prop_max_patch),x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19) + facet_wrap(~region) #geom_smooth(method = "ml",se=F)
g + ylab(expression(Delta~RS[max]))  +scale_colour_brewer(palette="Set1",name="Region",guide=FALSE) + 
	stat_quantile(quantiles=c(.10,.50,.90),linetype=2) +
	theme(axis.text.x = element_text(angle=90,hjust=0)) #
    #geom_crossbar(aes(ymax = (delta_max_patch)/total_patch_area, ymin = 0)) 
ggsave("figure/Delta_prop_patch_year_gt1e07.png",width=7,height=5,units="in",dpi=600)



# Test if quantiles are significative
#

qu <-group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_prop_max_patch)~year,data=.,tau=c(.10)),se="boot",R=999))[2,]))) %>% mutate(tau=.10, group="Prop")

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_prop_max_patch)~year,data=.,tau=c(.50)),se="boot",R=999))[2,]))) %>% mutate(tau=.50, group="Prop"))

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_prop_max_patch)~year,data=.,tau=c(.90)),se="boot",R=999))[2,]))) %>% mutate(tau=.90, group="Prop"))


#
# Absolute Fluctuation around the mean Smax - <Smax>
#
g <- ggplot(ff1, aes(y=(delta_max_patch),x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19) + facet_wrap(~region) #geom_smooth(method = "ml",se=F)
g + ylab(expression(Delta~S[max]~~~km^2))  +scale_colour_brewer(palette="Set1",name="Region",guide=FALSE) + 
	stat_quantile(quantiles=c(.10,.50,.90),linetype=2) +
	theme(axis.text.x = element_text(angle=90,hjust=0)) #
    #geom_crossbar(aes(ymax = (delta_max_patch)/total_patch_area, ymin = 0)) 
ggsave("figure/Delta_max_patch_year_gt1e07.png",width=7,height=5,units="in",dpi=600)

# Test if quantiles are significative
#

qu <-bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_max_patch)~year,data=.,tau=c(.10)),se="boot",R=999))[2,]))) %>% mutate(tau=.10, group="Abs",Value=round(Value,0),Std..Error=round(Std..Error,0)))

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_max_patch)~year,data=.,tau=c(.50)),se="boot",R=999))[2,]))) %>% mutate(tau=.50, group="Abs",Value=round(Value,0),Std..Error=round(Std..Error,0)))

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_max_patch)~year,data=.,tau=c(.90)),se="boot",R=999))[2,]))) %>% mutate(tau=.90, group="Abs",Value=round(Value,0),Std..Error=round(Std..Error,0)))




#
# Total patch area less than 1e07
#

ff1 <- filter(pstat,total_patch_area<1e7) %>% mutate(region1=paste0(region,subregion))

#
# Fluctuations around the mean Smax - <Smax>/TotArea
#
g <- ggplot(ff1, aes(y=delta_prop_max_patch,x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19) + facet_wrap(~region1)
g + ylab(expression(Delta~RS[max])) + scale_colour_brewer(palette="Set1",name="Sub-Region",guide=F) +
	theme(axis.text.x = element_text(angle=90,hjust=0)) +
	stat_quantile(quantiles=c(.10,.50,.90),linetype=2)
	# geom_crossbar(aes(ymax = (delta_max_patch)/total_patch_area, ymin = 0)) 

ggsave("figure/Delta_prop_patch_year_ls1e07.png",width=8,height=8,units="in",dpi=600)


# Test if quantiles are significative generate table
#

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_prop_max_patch)~year,data=.,tau=c(.10)),se="boot",R=999))[2,]))) %>% mutate(tau=.10, group="Prop"))

qu <- bind_rows(qu, group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_prop_max_patch)~year,data=.,tau=c(.50)),se="boot",R=999))[2,]))) %>% mutate(tau=.50, group="Prop"))

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_prop_max_patch)~year,data=.,tau=c(.90)),se="boot",R=999))[2,]))) %>% mutate(tau=.90, group="prop"))


#
# Absolute Fluctuations around the mean Smax - <Smax>
#
g <- ggplot(ff1, aes(y=delta_max_patch,x=year,colour=region)) +  theme_bw() +
	geom_point(shape=19) + facet_wrap(~region1)
g + ylab(expression(Delta~S[max]~~~(km^2))) + scale_colour_brewer(palette="Set1",name="Sub-Region",guide=F) +
	theme(axis.text.x = element_text(angle=90,hjust=0)) +
	stat_quantile(quantiles=c(.10,.50,.90),linetype=2)
	# geom_crossbar(aes(ymax = (delta_max_patch)/total_patch_area, ymin = 0)) 
ggsave("figure/Delta_max_patch_year_ls1e07.png",width=8,height=8,units="in",dpi=600)


# Test if quantiles are significative generate table
#

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_max_patch)~year,data=.,tau=c(.10)),se="boot",R=999))[2,]))) %>% mutate(tau=.10, group="Abs",Value=round(Value,0),Std..Error=round(Std..Error,0)))

qu <- bind_rows(qu, group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_max_patch)~year,data=.,tau=c(.50)),se="boot",R=999))[2,]))) %>% mutate(tau=.50, group="Abs",Value=round(Value,0),Std..Error=round(Std..Error,0)))

qu <- bind_rows(qu,group_by(ff1,region,subregion) %>% do(data.frame(t(coef(summary(rq((delta_max_patch)~year,data=.,tau=c(.90)),se="boot",R=999))[2,]))) %>% mutate(tau=.90, group="Abs",Value=round(Value,0),Std..Error=round(Std..Error,0)))


names(qu)[4]<-"StdError"
names(qu)[5]<-"t_value"
names(qu)[6]<-"p_value"

qu <- arrange(qu,region,subregion,group,desc(tau)) %>% 
	mutate(Value=round(Value,5),StdError=round(StdError,5),t_value=round(t_value,4),p_value=round(p_value,4))

pandoc.table(qu)

rm(ff1,fff,ff2)



save.image()

```

# Fit Max patch fluctuations to heavy tail distribution

```{r fitMaxPatchDynamics, eval=F,echo=T,message=T,warning=T}

#
# Skewness 
#
ff1<-filter(pstat, total_patch_area>1e7)
ff1<-pstat
require(fitdistrplus)
ku <-do(ff1,abs_skewness=(descdist(.$delta_max_patch, discrete=FALSE, boot=500))$skewness)
ku <-inner_join(ku,do(ff1,prop_skewness=descdist(.$delta_prop_max_patch, discrete=FALSE, boot=500)$skewness))

pandoc.table(ku, round=4)

# Evaluate Gumbel or Frechet distributions???????????????

#
# Fit Absolute max patch fluctuations to power law exponential and lognormal distributions
#
ff1<-filter(pstat, total_patch_area>1e7) %>%  mutate(delta_max_patch=abs(delta_max_patch))

fit_delta<-do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,-1,T,T)) %>% arrange(AICc)
#fit_delta1<-do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,0.0001)) %>% arrange(AICc)

ff1<-filter(pstat, total_patch_area<1e7) %>% mutate(delta_max_patch=abs(delta_max_patch)) #%>% filter(!is.na(delta_year_patch))

fit_delta<-bind_rows(fit_delta, do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,-1,T,T)))

pandoc.table(group_by(fit_delta,region,subregion) %>% arrange(AICc) %>% select( region:n, AICc_weight,GOFp) %>% 
			 mutate(par1=round(par1,3),
		    par2=round(par2,3),
		    xmin=round(xmin,4),
   	   		AICc_weight=round(AICc_weight,3),
		    GOFp=round(GOFp,4))
)

#
# Fit Relative max patch fluctuations to power law exponential and lognormal distributions
#

ff1<-filter(pstat, total_patch_area>1e7) %>%  mutate(delta_max_patch=abs(delta_prop_max_patch))

fit_delta<-do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,-1,T,T)) %>% arrange(AICc)
#fit_delta1<-do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,0.0001)) %>% arrange(AICc)

ff1<-filter(pstat, total_patch_area<1e7) %>% mutate(delta_max_patch=abs(delta_prop_max_patch)) #%>% filter(!is.na(delta_year_patch))

fit_delta<-bind_rows(fit_delta, do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,-1,T,T)))
#fit_delta1<-bind_rows(fit_delta1, do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,-1)))

pandoc.table(group_by(fit_delta,region,subregion) %>% arrange(AICc) %>% dplyr::select( region:n, AICc_weight,GOFp) %>% 
			 mutate(par1=round(par1,3),
		    par2=round(par2,3),
		    xmin=round(xmin,4),
   	   		AICc_weight=round(AICc_weight,3),
		    GOFp=round(GOFp,4))
)



#
# Annual patch fluctuations and xmin
# 

ff1<-filter(pstat, total_patch_area>1e7) %>% mutate(delta_max_patch=abs(delta_max_patch)) 
ff2<-group_by(fit_delta,region,subregion) %>% select(xmin) %>% inner_join(ff1) 

g <- ggplot(ff2, aes(y=delta_max_patch,x=as.factor(year),colour=region)) +  theme_bw() +
	geom_point(shape=19) + facet_wrap(~region) #geom_smooth(method = "ml",se=F)
g + ylab("Fluctuations Max Patch") + xlab("year") +scale_colour_brewer(palette="Set1",name="Region") + 
	theme(axis.text.x = element_text(angle=90,hjust=0)) + geom_hline(aes(yintercept=xmin,colour=region),linetype = 2) 
#ggsave("figure/Annual_abs_Delta_max_patch_year_gt1e07.png",width=8,height=6,units="in",dpi=600)

g + ylab("Fluctuations Max Patch") + xlab("year") +scale_colour_brewer(palette="Set1",name="Region") + 
	theme(axis.text.x = element_text(angle=90,hjust=0)) + geom_hline(aes(yintercept=xmin,colour=region),linetype = 2) 

ff1<-filter(pstat, total_patch_area<1e7)  %>% mutate(delta_max_patch=abs(delta_max_patch)) 
ff2<-group_by(fit_delta,region,subregion) %>% select(xmin) %>% inner_join(ff1)
g <- ggplot(ff2, aes(y=abs(delta_max_patch),x=as.factor(year),colour=subregion)) +  theme_bw() +
	geom_point(shape=19) + facet_wrap(~region) #geom_smooth(method = "ml",se=F)
g + ylab("Fluctuations Max Patch") + xlab("year") +scale_colour_brewer(palette="Set1",name="Region") + 
	theme(axis.text.x = element_text(angle=90,hjust=0)) + geom_hline(aes(yintercept=xmin,colour=subregion),linetype = 2)

```


# Check for monotonic increase in variance

The fligner test and other test for monotonic trends in variances have less power than quantile regression
Fligner 23%
monotonic 51%
quantile 83%

```{r varMaxPatchDynamics, eval=F,echo=T,message=T,warning=T}
require(lawstat)
require(quantreg)



# All Regions 
#
names(pstat)
# Split in groups of 7 years
# 

ff1<-pstat %>% group_by(region,subregion) %>% mutate(period=rep(1:3,each=5,length.out=15))

#ff1<-filter(ff1, !is.na(delta_year_prop_patch))


# Variances of the two groups
#
do(ff1, data.frame(matrix(aggregate(delta_prop_max_patch~period,data=.,FUN=var)[,2],nrow = 1)))

# Check autocorrelations
#
dev.off()
do(ff1,data.frame(matrix(acf(.$delta_prop_max_patch,plot=T)$acf,nrow=1)))

# p-value is 1.96/sqrt(T-lag)= 0.565803 (lag 2)

# Fluctuations in max patch proportions
#
# Non-parametric test for an increasing trend in variances 
#
ff2 <-do(ff1, data.frame(lnested.test(.$delta_prop_max_patch,.$period,bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff2)[3] <- "Increase"
#pandoc.table(ff2[,c(1,2,4,3)])

ff3 <-do(ff1, data.frame(lnested.test(.$delta_prop_max_patch,.$period,tail="left",bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff3)[3] <- "Decrease"

pandoc.table(inner_join(ff2,ff3) %>% mutate(Increase=round(Increase,4),Decrease=round(Decrease,4)))


# Fluctuation in absolute max patch area 
#
ff2 <- do(ff1, data.frame(lnested.test(.$delta_year_patch,.$period,bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff2)[3] <- "Increase"

ff3<-do(ff1, data.frame(lnested.test(.$delta_year_patch,.$period,tail="left",bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff3)[3] <- "Decrease"

pandoc.table(inner_join(ff2,ff3) %>% mutate(Increase=round(Increase,4),Decrease=round(Decrease,4)))


# Fluctuation in absolute max patch area 
#
ff1<-pstat %>% group_by(region,subregion) %>% mutate(period=rep(1:5,each=3,length.out=15))

# Check for autocorrelations
#
do(ff1,data.frame(matrix(acf(.$delta_max_patch,plot=T)$acf,nrow=1)))

ff2 <- do(ff1, data.frame(lnested.test(.$delta_prop_max_patch,.$period,bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff2)[3] <- "Increase"

ff3<-do(ff1, data.frame(lnested.test(.$delta_year_patch,.$period,tail="left",bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff3)[3] <- "Decrease"

pandoc.table(inner_join(ff2,ff3) %>% mutate(Increase=round(Increase,4),Decrease=round(Decrease,4)))

```


