# Sensitivity of the Power laws and max patch metrics to the threshold value to detect forest

## Setup

```{r setup, eval=T }
load(".RData")

oldcd <-getwd()

require(pander)
require(plyr)
require(dplyr)
require(ggplot2)
require(tictoc)

panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')
options("scipen"=6, "digits"=6)


# Functions for the analysis
#
source("R/power_fun.r")

# Load functions for continuous ht distributions
#
source("R/powerlaw/powerexp.R")
source("R/powerlaw/exp.R")
source("R/powerlaw/pareto.R")


# Set global options and parameters 
#
options.glo <- vector("list", length=0)
options.glo$GOF <- TRUE						# Estimate godness of fit for power law 
options.glo$ploting <- 0					# Plots of cumulative distributions
options.glo$data_set_name <- ""				# image_names from wich patch sizes were calculated
options.glo$resultsDir <- ""        		# Folder with bin files  
options.glo$sample_data <- 0                # Set  >0 For testing
options.glo$original_bin_files <- ""        # Files with patch sizes for each region (bin=binary)
options.glo$xmins <- seq(1:500)				# Range of xmins (minimun patch sizes) to fit 
											#
											# Size of the maximun xmin in Km 233*233*400/(1000*1000)
options.glo$fit <- TRUE 					# Make the fits or calculate patch stats





```

## Dataframes 

* all_fit: has all the fits of distributions with threshold=30, including GOF and bootstap confidence intervals of power laws

* all_fit_threshold: has all the fits with differnt thresholds, no GOF, no bootstrap estimation 

# Fit heavy tailed distributions AF (Africa - new output)

```{r conheavytailfitAF, eval=F,echo=T,message=T,warning=T}


# Set folder with results for the region 
#
# The original analysis
#
# options.glo$resultsDir <- "Results/africa"

# Folder with new data sets with different thresholds
#
options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/africa"

# Set random seed for reproducibility 
#
set.seed(seed=0)

# Fit the heavy tailed distributions for all binary files in the folder
#
tic("Python fitting heavy tailed")
fit <- call_python_powlawfit(options.glo$resultsDir,FALSE) 
toc()

# add to a new global data_frame
#
pyfit_threshold <- data_frame()
pyfit_threshold <- bind_rows(pyfit_threshold,fit$pyfit)


# Result of the distribution range 99.7
#
#   model_name higher     n        mlow         mhi    modFreq
#        <chr>  <lgl> <int>       <dbl>       <dbl>      <dbl>
# 1    LogNorm  FALSE   287 1.07123e-34 4.67543e-14 0.99652778
# 2    LogNorm   TRUE     1 1.63852e-11 7.84487e+00 0.00347222
# 3 LogNormPos   TRUE   288 2.71207e-04 4.04711e+03 1.00000000

rm(fit)
save.image()

# Fitting heavy tailed: 7481.035 sec elapsed, NO paralell code and no GOF
# Python fitting heavy tailed: 372.726 sec elapsed

# Plots fits for AF (Africa) 
#
# The plots are saved in Results/africa folder
#
#
#plot_size_dist_by_region("AF","Results/africa",30)


```

# Fit heavy tailed distributions SEAS (south asia)

```{r conheavytailfitSEAS, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 

# options.glo$resultsDir <- "Results/southasia"
options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/southasia"

options.glo$sample_data <- 0                 # Set >0 For testing


set.seed(seed=0)

tic("Python fitting heavy tailed")
fit <- call_python_powlawfit(options.glo$resultsDir) 
toc()

# Fitting heavy tailed SEAS: 5125.844 sec elapsed

# Add the fitted distribution models data to all_fit data frame 
#
# add to a new global data_frame
#
pyfit_threshold <- bind_rows(pyfit_threshold,fit$pyfit)

# Result of the distribution range 99.7
#
#   model_name higher     n        mlow         mhi modFreq
#        <chr>  <lgl> <int>       <dbl>       <dbl>   <dbl>
# 1    LogNorm  FALSE   288 3.20462e-51 2.59915e-25       1
# 2 LogNormPos   TRUE   288 3.61299e-04 4.88225e+03       1


rm(fit)
save.image()

# Plots fits
#
# plot_size_dist_by_region("SEAS","Results/southasia")

```


# Fit heavy tailed distributions OC (Oceania)

```{r conheavytailfitOC, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 

#options.glo$resultsDir <- "Results/oceania"
options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/oceania"

set.seed(seed=0)

tic("Python fitting heavy tailed")
fit <- call_python_powlawfit(options.glo$resultsDir) 
toc()
# Fitting heavy tailed OC: 3233.113 sec elapsed

# Result of the distribution range 99.7
#
#   model_name higher     n        mlow         mhi modFreq
#        <chr>  <lgl> <int>       <dbl>       <dbl>   <dbl>
# 1    LogNorm  FALSE  1152 9.42026e-39 1.43738e-16       1
# 2 LogNormPos   TRUE  1152 5.82053e-04 2.74795e+03       1

  Add the fitted distribution models data to all_fit data frame 
#
pyfit_threshold <- bind_rows(pyfit_threshold,fit$pyfit)

rm(fit)
save.image()

# plot_size_dist_by_region("OC","Results/oceania")

```



# Fit heavy tailed distributions SA (south america)

```{r conheavytailfitSA, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 
#
# options.glo$resultsDir <- "Results/southamerica"

# Sensititivity analisis and new 2015 
#
options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/southamerica"


set.seed(seed=0)
tic("Python fitting heavy tailed")
fit <- call_python_powlawfit(options.glo$resultsDir,FALSE) 
toc()
# Fitting heavy tailed SA: 9271.123 sec elapsed

#   model_name higher     n        mlow         mhi modFreq
#        <chr>  <lgl> <int>       <dbl>       <dbl>   <dbl>
# 1    LogNorm  FALSE   432 2.56357e-28 5.95092e-09       1
# 2 LogNormPos   TRUE   432 2.28301e-04 5.69198e+03       1

#  Add the fitted distribution models data to all_fit data frame 
#
pyfit_threshold <- bind_rows(pyfit_threshold,fit$pyfit)

rm(fit)

save.image()

# Plots HAVE TO FILTER BY THRESHOLD VALUE!!!!
#
#plot_size_dist_by_region("SA","Results/southamerica")


```

# North america fits

```{r conheavytailfitNA, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 
#
#options.glo$resultsDir <- "Results/northamerica"
#
options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/northamerica"

tic("Python fitting heavy tailed")
fit <- call_python_powlawfit(options.glo$resultsDir,FALSE) 
toc()
# Fitting heavy tailed NA: 7948.865 sec elapsed

#  Add the fitted distribution models data to all_fit data frame 
#
pyfit_threshold <- bind_rows(pyfit_threshold,fit$pyfit)

#   model_name higher     n        mlow             mhi    modFreq
#        <chr>  <lgl> <int>       <dbl>           <dbl>      <dbl>
# 1    LogNorm  FALSE   511 1.18154e-17    0.0000172011 0.99416342
# 2    LogNorm   TRUE     3 7.78206e-05   15.8818205295 0.00583658
# 3 LogNormPos   TRUE   514 4.69762e-02 1654.8680805708 1.00000000

rm(fit)

save.image()

#
#plot_size_dist_by_region("NA","Results/northamerica")
#

```

# Fit heavy tailed distributions EUAS (Europa north asia)



```{r conheavytailfitEUAS, eval=F,echo=T,message=T,warning=T}

# Set folder with results for the region 
#
# options.glo$resultsDir <- "Results/eurasia"
options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/eurasia"

tic("Python fitting heavy tailed")
fit <- call_python_powlawfit(options.glo$resultsDir,FALSE) 
toc()

#   model_name higher     n        mlow             mhi   modFreq
#        <chr>  <lgl> <int>       <dbl>           <dbl>     <dbl>
# 1    LogNorm  FALSE   426 7.08543e-19    0.0000321927 0.9861111
# 2    LogNorm   TRUE     6 1.80158e-05  341.2559817713 0.0138889
# 3 LogNormPos   TRUE   432 3.44860e-04 4924.5115823363 1.0000000

#  Add the fitted distribution models data to all_fit data frame 
#
pyfit_threshold <- bind_rows(pyfit_threshold,fit$pyfit)

rm(fit)

save.image()

# plot_size_dist_by_region("EUAS","Results/eurasia")


```

# Plot and table of alpha by region and subregion and Threshold and proportion of best models 

```{r conheavytailplots, eval=F,echo=F,message=T,warning=T}
setwd(oldcd)

require(dplyr)
require(ggplot2)

pyfit_threshold <- pyfit_threshold %>% mutate(regsub = paste0(region,subregion)) 
pyfit_threshold <- pyfit_threshold %>% filter(regsub !="NA2",regsub !="NA3",regsub !="NA4"))

pyfit_threshold %>% filter(regsub !="NA4") %>% summarise(n=n())
pyfit_threshold <- pyfit_threshold %>% filter(regsub !="NA4")

unique(pyfit_threshold$regsub)

ff <- pyfit_threshold %>% filter(model_name=="Power" ) %>% 
	mutate(se=(par1-1)/sqrt(n),lPar1=par1-2*se,hPar1=par1+2*se)

pd <-position_dodge(.3)
g <- ggplot(ff, aes(x=year,y=par1,colour=threshold),shape=22) +  theme_bw() + geom_point(position=pd,size=1.5)+ 
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5,position=pd) + ylab(expression(alpha)) + 
	scale_colour_brewer(palette="Set1",guide=F) + theme(legend.position="bottom") +  theme(axis.text.x = element_text(angle = 90, hjust = 0))


ff1<- group_by(ff,regsub) %>% summarise(malpha=mean(par1),mxmin=mean(xmin))

g + geom_hline(aes(yintercept=malpha,colour=regsub),ff1,linetype = 2) + facet_wrap( ~regsub) 

fff <-filter(ff,subregion==1,region!="SAT",region!="OC", threshold %in% c(20,30,40))
g <- ggplot(fff, aes(x=year,y=par1,colour=threshold),shape=21) +  theme_bw() + geom_point(position=pd,size=1.5)+ 
	geom_errorbar(aes(ymin=lPar1, ymax=hPar1),width=0.5,position=pd) + ylab(expression(alpha)) +
	scale_colour_brewer(palette="Set1",name="Region") + theme(legend.position="bottom") +  theme(axis.text.x = element_text(angle = 90, hjust = 0))

ff1<- group_by(fff,region,subregion) %>% summarise(malpha=mean(par1),mxmin=mean(xmin))

g + geom_hline(aes(yintercept=malpha),ff1,linetype = 2) + facet_wrap( ~region)
#ggsave("figure/PowerExp_gt10e7_year.png",width=6,height=6,units="in",dpi=600)


#
# Mean alpha and Xmin by region
#
ta <-filter(pyfit_threshold,model_name=="Power") %>% group_by(region,subregion,threshold) %>% summarise(alpha=mean(par1),xmin=mean(xmin))

pandoc.table(ta)

#
# Proportion of Selected models 
# 
names(all_fit_treshold)
tot_fit_by_model <- pyfit_threshold %>% group_by(region,subregion,threshold,model_name) %>% mutate(tot_by_model=n()) %>% 
	filter(delta_AICc==0) %>% summarise(best_model_prop=n()/max(tot_by_model)) %>% select(model_name,best_model_prop)  

#
# Plot proportion of best models by region-subregion - ALL thresholds
#
unique(tot_fit_by_model$threshold)
tot_fit_by_model1 <- tot_fit_by_model %>% ungroup %>% mutate(region = paste0(region,subregion)) #%>% filter(threshold %in% c(25,27.5,30,32.5,35))
ggplot(tot_fit_by_model1, aes(x=region,y=best_model_prop,fill=model_name)) + geom_bar(stat="identity") + theme_bw() + scale_colour_brewer(palette="Set1") + theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust=.5),axis.title.x = element_blank()) + ylab("Best models proportion")  + scale_fill_discrete(name="Models") + facet_wrap( ~threshold )

ggsave("figure/BestModelByThreshold.png",width=8,height=6,units="in",dpi=600)

#
# Plot proportion of best models by region-subregion - 25 - 35 thresholds
#
unique(tot_fit_by_model$threshold)
tot_fit_by_model1 <- tot_fit_by_model %>% ungroup %>% mutate(region = paste0(region,subregion)) %>% filter(threshold %in% c(20,25,30,35,40))
ggplot(tot_fit_by_model1, aes(x=region,y=best_model_prop,fill=model_name)) + geom_bar(stat="identity") + theme_bw() + scale_colour_brewer(palette="Set1") + theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust=.5),axis.title.x = element_blank()) + ylab("Best models proportion")  + scale_fill_discrete(name="Models") + facet_wrap( ~threshold )

ggsave("figure/BestModelByThreshold.png",width=8,height=6,units="in",dpi=600)


#
# Power exp and power law alpha difference at threshold 30 = 0.01121
#

ta <-filter(pyfit_threshold,model_name=="Power",regsub=="EUAS3") %>% select(model_name:file_name,threshold) 
ta <-bind_rows(ta, filter(pyfit_threshold,model_name=="PowerExp",regsub=="EUAS3") %>% select(model_name:file_name,threshold) )
ta %>% group_by(threshold,model_name) %>% summarize(alpha=mean(par1))

rm(ta)
```

# Calculate bootstraped confidence intervals by threshold for alpha parameter 

```{r alphaGLS, eval=F,echo=T,message=T,warning=T}

ff <- filter(pyfit_threshold,model_name=="Power") %>% 
	mutate(se=(par1-1)/sqrt(n),weight=se,year=as.numeric(year),region=paste0(region,subregion)  )



require(boot)
mymean <- function(dat,i) mean(dat[i])

threshold_ci <- group_by(ff,region,threshold) %>% do( {
				myboot <- boot(.$par1,mymean,R=10000)
				myci <- boot.ci(myboot)
				data_frame(malpha=myboot$t0,low=myci$bca[4],high=myci$bca[5])
				})

require(viridis)

ggplot(threshold_ci, aes(threshold,malpha,colour=region)) + geom_point(shape=22) + geom_linerange(aes(ymin = low, ymax = high)) +theme_bw()+ ylab(expression(paste("Average ",alpha)))+ coord_flip() + scale_colour_viridis(discrete = T,guide=FALSE) + facet_wrap(~region)


threshold_ci1 <- filter(threshold_ci,threshold %in% c(25,27.5,30,32.5,35))
ggplot(threshold_ci1, aes(threshold,malpha,colour=region)) + geom_point(shape=22) + geom_linerange(aes(ymin = low, ymax = high)) +theme_bw()+ ylab(expression(paste("Average ",alpha)))+ coord_flip() + scale_colour_viridis(discrete = T,guide=FALSE) + facet_wrap(~region)

ggsave("figure/AverageAlphaByRegionThreshold25-30.png",width=8,height=6,units="in",dpi=600)



```

# Extract max patch size and patch stats  

## Data Frames

pstat            Original patch stats 30 threshold, RSmax=prop_max_patch, Smax=max_patch
pstat_threshold  Patch stats with variable threshold 10-40



```{r extractPatchStats, eval=F,echo=T,message=T,warning=T}

#require(doParallel)
require(plyr)
require(dplyr)
require(ggplot2)
setwd(oldcd)

options.glo$sample_data <- 0                 # Set >0 For testing
options.glo$fit <- FALSE                     # Calculate patch stats

pstat_threshold <-data.frame()


options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/africa"

pstat_threshold <- rbind(pstat_threshold,region_fit_con_heavy_tail(options.glo,"AF") )


options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/southasia"

pstat_threshold <- rbind(pstat_threshold,region_fit_con_heavy_tail(options.glo,"SEAS") )


options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/oceania"

pstat_threshold <- rbind(pstat_threshold,region_fit_con_heavy_tail(options.glo,"OC") )

options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/southamerica"
pstat_threshold <- rbind(pstat_threshold,region_fit_con_heavy_tail(options.glo,"SA") )

options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/northamerica"
pstat_threshold <- rbind(pstat_threshold,region_fit_con_heavy_tail(options.glo,"NA") )

options.glo$resultsDir <- "~/Dropbox1T/GlobalCriticalForest/Results/GCF_first_paper_sensitivity_analysis/eurasia"
pstat_threshold <- rbind(pstat_threshold,region_fit_con_heavy_tail(options.glo,"EUAS") )

pstat_threshold <-pstat_threshold %>% filter(!(region=="NA"& subregion %in% c(2,3,4)))

pstat_threshold <-mutate(pstat_threshold, regsub = paste0(region,subregion))

pstat_threshold <-pstat_threshold %>% filter(year != 2015 ) %>% ungroup()
unique(pstat_threshold$regsub)

names(pstat_threshold)
#
# Max patch plot
#
g <- ggplot(filter(pstat_threshold,threshold %in% c(20,25,30,35,40)), aes(y=max_patch,x=year,colour=threshold)) +  theme_bw() +
	geom_point(shape=19) +  facet_wrap(~regsub)
g + ylab(expression(S[max]~Km^2))  +scale_colour_brewer(palette="Set1",name="Sub-region") + scale_y_log10() + theme(axis.text.x = element_text(angle=90,hjust=0))

#ggsave("figure/max_patch_year.png",width=7,height=6,units="in",dpi=600)


save.image()



#
# Add max patch with alpha
#
ta <-filter(pyfit_threshold,model_name=="Power") %>% group_by(regsub,threshold) %>% summarise(alpha=mean(par1),xmin=mean(xmin))

require(boot)
mymean <- function(dat,i) mean(dat[i])
totarea_ci <- group_by(pstat_threshold,regsub,threshold) %>% do( {
				myboot <- boot(.$total_patch_area,mymean,R=10000)
				myci <- boot.ci(myboot)
				data_frame(mean_tot_area=myboot$t0,low=myci$bca[4],high=myci$bca[5])
				})

ta <-inner_join(ta,totarea_ci)

require(viridis)
#
# Total area greater than 10.000.000
#

ggplot(filter(ta,mean_tot_area>1e7, threshold %in% c(20,25,30,35,40))%>% mutate_if(is.numeric,funs(./1e07)), aes(y=mean_tot_area,x=threshold,colour=regsub)) +  theme_bw() + geom_point(shape=22)+ geom_linerange(aes(ymin = low, ymax = high)) + ylab(expression(Total~patch~area~10^7~Km^2))  + scale_colour_viridis(discrete=T,name="Region",guide=FALSE) + facet_wrap(~regsub) + theme(legend.position="bottom") + coord_flip()
ggsave("figure/TotPatch_ByThreshold_gt1e07.png",width=6,height=6,units="in",dpi=600)

#
# Total area less than 10.000.000
#
ggplot(filter(ta,mean_tot_area<=1e7,threshold %in% c(20,25,30,35,40))%>% mutate_if(is.numeric,funs(./1e06)), aes(y=mean_tot_area,x=threshold,colour=regsub)) +  theme_bw() +
	geom_point(shape=22)+ geom_linerange(aes(ymin = low, ymax = high)) + ylab(expression(Total~patch~area~10^6~Km^2))  + scale_colour_viridis(discrete=T,name="Region",guide=FALSE) + facet_wrap(~regsub) + theme(legend.position="bottom") +  coord_flip()
ggsave("figure/TotPatch_ByThreshold_le1e07.png",width=6,height=6,units="in",dpi=600)

names(pstat_threshold)
ggplot(filter(pstat_threshold,regsub=="EUAS1",threshold %in% c(20,25,30,35,40))%>% mutate(total_patch_area=total_patch_area/1e06), aes(y=total_patch_area,x=year,colour=threshold)) +  theme_bw() +
	geom_point(shape=22)+ ylab(expression(Total~patch~area~10^6~Km^2))  + scale_colour_viridis(discrete=T,name="Region",guide=FALSE) + theme(legend.position="bottom") 

```

# Max patch dynamics

## Data Frames	     

qu               Original quantile regressions of fluctuations of patch dynamics with 30 threshold
qu_treshold      New fluctuation of patch dynamics with variable threshold


* Calculate Fluctuations of maximun patch by year delta_RSmax = Smax - <Smax>/TotArea

* Absolute Fluctuations around the mean by year   delta_Smax = Smax - <Smax>

```{r maxPatchdynamics, eval=F,echo=T,message=T,warning=T}

require(dplyr)
require(ggplot2)
require(quantreg)
require(viridis)


#
# Calculte some deltas
# 
pstat_threshold<- group_by(pstat_threshold,regsub,threshold) %>%  mutate(year=as.numeric(year),
																		 mean_max_patch=mean(max_patch), 
											  prop_max_patch=max_patch/total_patch_area,  # Max patch proportion
											  delta_max_patch=max_patch-mean_max_patch,   # Delta max patch
											  delta_prop_max_patch=delta_max_patch/total_patch_area, # Delta max patch proportion
											  delta_year_patch=max_patch-lag(max_patch,order_by=year), 
											  delta_year_prop_patch=prop_max_patch-lag(prop_max_patch,order_by=year)
											) 

# Average RSmax 
#
require(boot)
mymean <- function(dat,i) mean(dat[i])

rsmax_ci <- group_by(pstat_threshold,regsub,threshold) %>% do( {
				myboot <- boot(.$prop_max_patch,mymean,R=10000)
				myci <- boot.ci(myboot)
				data_frame(mRSmax=myboot$t0,low=myci$bca[4],high=myci$bca[5])
				})

require(viridis)
ggplot(filter(rsmax_ci,threshold %in% c(20,25,30,35,40)), aes(threshold,mRSmax,colour=regsub)) + geom_point(shape=22) + geom_linerange(aes(ymin = low, ymax = high)) +theme_bw()+ ylab(expression(paste("Average ",RS[max])))+ coord_flip() + scale_colour_viridis(discrete = T,guide=FALSE) + facet_wrap(~regsub) + theme(axis.text.x = element_text(angle=90, hjust = 0, vjust=.5)) + scale_y_continuous(breaks = c(.2,.4,.6,.8))
ggsave("figure/RSmax_ByThreshold.png",width=6,height=6,units="in",dpi=600)

ggplot(filter(rsmax_ci,threshold %in% c(20,25,30,35,40)), aes(threshold,mRSmax,colour=regsub)) + geom_point(shape=22) + geom_linerange(aes(ymin = low, ymax = high)) +theme_bw()+ ylab(expression(paste("Average ",RS[max])))+ coord_flip() + scale_colour_viridis(discrete = T,guide=FALSE) + facet_wrap(~regsub)  + theme(axis.text.x = element_text(angle=90, hjust = 0, vjust=.5))
#ggsave("figure/RSmax_ByThreshold25-35.png",width=6,height=6,units="in",dpi=600)



ff2<- group_by(pstat_threshold,regsub,threshold) %>%  summarise(mmaxpatch=mean(max_patch),mtotpatch=mean(total_patch_area),mprop=round(mmaxpatch/mtotpatch,2))
pandoc.table(ff2,round=2)

#
# Max patch proportion plot greater than 1e7 Km2
#
ff1 <- filter(pstat_threshold,regsub %in% c("AF1","EUAS1","NA1","SAST1","SEAS1"), threshold %in% c(20,25,30,35,40)) 
pd <-position_dodge(.3)
g <- ggplot(ff1, aes(y=prop_max_patch,x=year,colour=regsub)) +  theme_bw() +
	geom_point(shape=19,position=pd) + facet_wrap(~threshold) + scale_colour_brewer(palette="Set1",name="Region")

ff2<- group_by(ff1,regsub,threshold) %>%  summarise(mprop=mean(prop_max_patch))

g + ylab(expression(RS[max]))  +
	theme(axis.text.x = element_text(angle=90,hjust=0)) + geom_hline(aes(yintercept=mprop,colour=regsub),ff2,linetype = 2) 

ggsave("figure/RSmax_gt1e7_ByYearThreshold.png",width=6,height=6,units="in",dpi=600)


plot_RSmax_yearThreshold(pstat_threshold,"AF1")
plot_RSmax_yearThreshold(pstat_threshold,"EUAS1")
plot_RSmax_yearThreshold(pstat_threshold,"NA1")
plot_RSmax_yearThreshold(pstat_threshold,"SAST1")
plot_RSmax_yearThreshold(pstat_threshold,"SEAS1")
plot_RSmax_yearThreshold(pstat_threshold,"SEAS2")


#
# Calculate the average RSmax and the variance by threshold
#
ff2<- mutate(pstat_threshold, RSmax= max_patch/total_patch_area) %>% group_by(regsub,threshold) %>%  summarise(mmaxpatch=mean(max_patch),mtotpatch=mean(total_patch_area),mRSmax=mean(RSmax),sdRSmax=sd(RSmax))

ggplot(ff2, aes(regsub,mRSmax,colour=regsub)) + geom_point() + geom_linerange(aes(ymin = mRSmax-sdRSmax, ymax = mRSmax+sdRSmax)) +theme_bw()+coord_flip() + scale_colour_viridis(discrete = T,guide=FALSE) + facet_wrap(~threshold)# + scale_y_log10()  


ff2 %>% filter(sdRSmax==max(sdRSmax))

#
# Fluctuations of maximun patch vs year Smax - <Smax>/TotArea
#
#
# Areas greater than 10000000 km2
#
#
# Test if quantiles are significative
#

ff1<-filter(pstat_threshold, year<2015, threshold %in% c(20,25,30,35,40))  

qu_treshold <-group_by(ff1,regsub,threshold) %>% do(data.frame(t(coef(summary(rq((delta_prop_max_patch)~year,data=.,tau=c(.10)),se="boot",R=999))[2,]))) %>% mutate(tau=.10, group="Prop") %>% rename(StdError=Std..Error,t_value=t.value,p_value=Pr...t..)
qu_treshold <- bind_rows(qu_treshold,group_by(ff1,regsub,threshold) %>% do(data.frame(t(coef(summary(rq((delta_prop_max_patch)~year,data=.,tau=c(.50)),se="boot",R=999))[2,]))) %>% mutate(tau=.50, group="Prop") %>% rename(StdError=Std..Error,t_value=t.value,p_value=Pr...t..))

qu_treshold <- bind_rows(qu_treshold,group_by(ff1,regsub,threshold) %>% do(data.frame(t(coef(summary(rq((delta_prop_max_patch)~year,data=.,tau=c(.90)),se="boot",R=999))[2,]))) %>% mutate(tau=.90, group="Prop")%>% rename(StdError=Std..Error,t_value=t.value,p_value=Pr...t..))


qu1 <- filter(qu_treshold, p_value<0.05) %>% arrange( regsub,threshold)
pandoc.table(qu1)
#
# RSmax Fluctuations around the mean Smax - <Smax>/TotArea
#
plot_RSmax_Fluctuations_yearThreshold(pstat_threshold, "AF1")
plot_RSmax_Fluctuations_yearThreshold(pstat_threshold, "SEAS2")
plot_RSmax_Fluctuations_yearThreshold(pstat_threshold, "SAST1")
plot_RSmax_Fluctuations_yearThreshold(pstat_threshold, "EUAS1")



#
# Absolute Fluctuations around the mean Smax - <Smax>
#

# Test if quantiles are significative generate table
#
ff1<-filter(pstat_threshold, year<2015)   

qu_treshold <- bind_rows(qu_treshold,group_by(ff1,regsub,threshold) %>% do(data.frame(t(coef(summary(rq((delta_max_patch)~year,data=.,tau=c(.10)),se="boot",R=999))[2,]))) %>% mutate(tau=.10, group="Abs",Value=round(Value,0),Std..Error=round(Std..Error,0)) %>% rename(StdError=Std..Error,t_value=t.value,p_value=Pr...t..))

qu_treshold <- bind_rows(qu_treshold, group_by(ff1,regsub,threshold) %>% do(data.frame(t(coef(summary(rq((delta_max_patch)~year,data=.,tau=c(.50)),se="boot",R=999))[2,]))) %>% mutate(tau=.50, group="Abs",Value=round(Value,0),Std..Error=round(Std..Error,0)) %>% rename(StdError=Std..Error,t_value=t.value,p_value=Pr...t..))

qu_treshold <- bind_rows(qu_treshold,group_by(ff1,regsub,threshold) %>% do(data.frame(t(coef(summary(rq((delta_max_patch)~year,data=.,tau=c(.90)),se="boot",R=999))[2,]))) %>% mutate(tau=.90, group="Abs",Value=round(Value,0),Std..Error=round(Std..Error,0)) %>% rename(StdError=Std..Error,t_value=t.value,p_value=Pr...t..))

qu2<-filter(qu_treshold, p_value<0.05, threshold %in% c(20,25,30,35,40))  %>% arrange( regsub,threshold) %>% mutate_if(is.numeric,round, digits=4)  

pandoc.table(qu2)

# The paterns of the quantile slopes are robust to the threshold, in the range 10-40, with one exception EUAS1 40 change to negative 
# The fits of the distributions of patches are also robust range 25-35
# The Skewness is less robust rante 27.2 32.5

plot_Smax_Fluctuations_yearThreshold(pstat_threshold, "EUAS1")
plot_Smax_Fluctuations_yearThreshold(pstat_threshold, "AF1")
plot_Smax_Fluctuations_yearThreshold(pstat_threshold, "SEAS2")
plot_Smax_Fluctuations_yearThreshold(pstat_threshold, "EUAS2")


pandoc.table(arrange(qu_treshold,regsub,group,desc(tau)) %>% 
	mutate(Value=round(Value,5),StdError=round(StdError,5),t_value=round(t_value,4),p_value=round(p_value,4)))


rm(ff1,fff,ff2,qu1,qu2)



save.image()

```

# Calculate Skewness and Fit Max patch fluctuations to heavy tail distribution


```{r fitMaxPatchDynamics, eval=F,echo=T,message=T,warning=T}

#
# Skewness 
#
ff1<-pstat_threshold
require(fitdistrplus)
ku <-do(ff1,abs_skewness=(descdist(.$delta_max_patch, discrete=FALSE, boot=500))$skewness)
ku <-inner_join(ku,do(ff1,prop_skewness=descdist(.$delta_prop_max_patch, discrete=FALSE, boot=500)$skewness))
ku <- ku %>% mutate(prop_skewness= unlist(prop_skewness), abs_skewness=unlist(abs_skewness))

pandoc.table(ku, round=4)

ggplot(filter(ku,threshold %in% c(27.5,30,32.5)), aes(x=regsub,y=abs_skewness,colour=threshold)) + geom_point(shape=22)  +theme_bw()+ ylab(expression(paste("Skewness ",S[max])))+ coord_flip() + scale_colour_viridis(discrete = T) + geom_point(data=filter(ku,threshold==30),colour="red")

ggplot(filter(ku,threshold %in% c(27.5,30,32.5)), aes(x=regsub,y=prop_skewness,colour=threshold)) + geom_point(shape=22)  +theme_bw()+ ylab(expression(paste("Skewness ",S[max])))+ coord_flip() + scale_colour_viridis(discrete = T) + geom_point(data=filter(ku,threshold==30),colour="red")

skewness_threshold <- ku 
rm(ku,ff1)

#
# Fit Absolute max patch fluctuations to power law exponential and lognormal distributions
#
ff1<-filter(pstat_threshold, year<2015) %>%  mutate(delta_max_patch=abs(delta_max_patch))

fit_delta_threshold<-do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,-1,TRUE,FALSE)) %>% mutate(group="Abs") 

fft <- fit_delta_threshold %>% filter(delta_AICc==0) %>% arrange(regsub)

#
# Fit Relative max patch fluctuations to power law exponential and lognormal distributions
#

ff1<-filter(pstat_threshold, year<2015) %>%  mutate(delta_max_patch=abs(delta_prop_max_patch))

# Fit models, estimate xmins, Do Plots, Do not do GOF
#
fit_delta_threshold<-bind_rows(fit_delta_threshold, do(ff1,fit_cont_heavy_tail_mdls(.$delta_max_patch,-1,TRUE,FALSE)) %>% mutate(group="Prop")) 

fft <- fit_delta_threshold %>% filter(delta_AICc==0) %>% arrange(regsub) %>% select(regsub:n, AICc_weight,group)

pandoc.table(filter(fit_delta_threshold,delta_AICc==0) %>% select( regsub:n, AICc_weight,group) %>% 
			 mutate(par1=round(par1,3),
		    par2=round(par2,3),
		    xmin=round(xmin,4),
   	   		AICc_weight=round(AICc_weight,3))
			 
)

pandoc.table(filter(fit_delta_threshold,delta_AICc==0,threshold==30) %>% arrange(regsub) %>% select( regsub:n, AICc_weight,group) %>% 
			 mutate(par1=round(par1,3),
		    par2=round(par2,3),
		    xmin=round(xmin,4),
   	   		AICc_weight=round(AICc_weight,3))
			 
)


rm(ff1,ff2,fft)
save.image()
```


# Check for monotonic increase in variance

The fligner test and other test for monotonic trends in variances have less power than quantile regression
Fligner 23%
monotonic 51%
quantile 83%

```{r varMaxPatchDynamics, eval=F,echo=T,message=T,warning=T}

require(lawstat)
require(quantreg)



# All Regions 
#
names(pstat)
# Split in groups of 7 years
# 

ff1<-pstat %>% group_by(region,subregion) %>% mutate(period=rep(1:3,each=5,length.out=15))

#ff1<-filter(ff1, !is.na(delta_year_prop_patch))


# Variances of the two groups
#
do(ff1, data.frame(matrix(aggregate(delta_prop_max_patch~period,data=.,FUN=var)[,2],nrow = 1)))

# Check autocorrelations
#
dev.off()
do(ff1,data.frame(matrix(acf(.$delta_prop_max_patch,plot=T)$acf,nrow=1)))

# p-value is 1.96/sqrt(T-lag)= 0.565803 (lag 2)

# Fluctuations in max patch proportions
#
# Non-parametric test for an increasing trend in variances 
#
ff2 <-do(ff1, data.frame(lnested.test(.$delta_prop_max_patch,.$period,bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff2)[3] <- "Increase"
#pandoc.table(ff2[,c(1,2,4,3)])

ff3 <-do(ff1, data.frame(lnested.test(.$delta_prop_max_patch,.$period,tail="left",bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff3)[3] <- "Decrease"

pandoc.table(inner_join(ff2,ff3) %>% mutate(Increase=round(Increase,4),Decrease=round(Decrease,4)))


# Fluctuation in absolute max patch area 
#
ff2 <- do(ff1, data.frame(lnested.test(.$delta_year_patch,.$period,bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff2)[3] <- "Increase"

ff3<-do(ff1, data.frame(lnested.test(.$delta_year_patch,.$period,tail="left",bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff3)[3] <- "Decrease"

pandoc.table(inner_join(ff2,ff3) %>% mutate(Increase=round(Increase,4),Decrease=round(Decrease,4)))


# Fluctuation in absolute max patch area 
#
ff1<-pstat %>% group_by(region,subregion) %>% mutate(period=rep(1:5,each=3,length.out=15))

# Check for autocorrelations
#
do(ff1,data.frame(matrix(acf(.$delta_max_patch,plot=T)$acf,nrow=1)))

ff2 <- do(ff1, data.frame(lnested.test(.$delta_prop_max_patch,.$period,bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff2)[3] <- "Increase"

ff3<-do(ff1, data.frame(lnested.test(.$delta_year_patch,.$period,tail="left",bootstrap = T,num.bootstrap = 999,correction.method="zero.correction")$N[2]))

names(ff3)[3] <- "Decrease"

pandoc.table(inner_join(ff2,ff3) %>% mutate(Increase=round(Increase,4),Decrease=round(Decrease,4)))

```


